"use client";

import { useSession } from "next-auth/react";

import React, { useState, useEffect, useRef } from "react";
import { DashboardSidebar } from "@/components/dashboard/Sidebar";
import { BlockConfigRenderer } from "@/components/automations/block-configs";
import { DashboardHeader } from "@/components/dashboard/Header";
import { Button } from "@/components/ui/button";
import { Input } from "@/components/ui/input";
import { Badge } from "@/components/ui/badge";
import { Card, CardContent } from "@/components/ui/card";
import {
  ArrowLeft,
  Save,
  Play,
  Plus,
  Settings,
  MessageSquare,
  Bot,
  Zap,
  GitBranch,
  Clock,
  Trash2,
  ShoppingCart,
  Package,
  CreditCard,
  Users,
  Calendar,
  Sparkles,
  Send,
  Image,
  FileText,
  MapPin,
  Contact2,
  HelpCircle,
  Target,
  Megaphone,
  HeartHandshake,
  Store,
  ChevronRight,
  Wand2,
  LayoutTemplate,
  PlusCircle,
  X,
  Check,
  CheckCircle2,
  XCircle,
  ArrowRight,
  Star,
  GripVertical,
  ZoomIn,
  ZoomOut,
  Maximize2,
  Minus,
  Rocket,
  AlertTriangle,
  Terminal,
  Activity,
  Loader2,
  ShieldCheck,
  SendHorizontal,
  BotMessageSquare,
  Upload,
  ImageIcon,
  UserPlus,
  UserMinus,
  UserX,
  Search,
  UserSearch,
  Map,
  Link2,
  Filter,
  Flame,
  ListChecks,
  Globe,
  Cpu,
  Smile,
  ShoppingBag,
  Truck,
  Mail,
  Trophy,
  BookOpen,
  Briefcase,
  Utensils,
  Box,
  Bell,
  Smartphone,
  QrCode,
  Mic,
  Edit2,
} from "lucide-react";
import { motion, AnimatePresence } from "framer-motion";
import Link from "next/link";
import { WhatsAppSimulator } from "@/components/dashboard/WhatsAppSimulator";
import PhoneInput, {
  getCountryCallingCode,
  Country,
} from "react-phone-number-input";
import "react-phone-number-input/style.css";
import en from "react-phone-number-input/locale/en";

// Labels personnalis√©s avec pr√©fixes t√©l√©phoniques
const customLabels: Record<string, string> = {
  ZZ: "International",
  AF: "Afghanistan (+93)",
  AL: "Albania (+355)",
  DZ: "Algeria (+213)",
  AS: "American Samoa (+1684)",
  AD: "Andorra (+376)",
  AO: "Angola (+244)",
  AI: "Anguilla (+1264)",
  AG: "Antigua and Barbuda (+1268)",
  AR: "Argentina (+54)",
  AM: "Armenia (+374)",
  AW: "Aruba (+297)",
  AU: "Australia (+61)",
  AT: "Austria (+43)",
  AZ: "Azerbaijan (+994)",
  BS: "Bahamas (+1242)",
  BH: "Bahrain (+973)",
  BD: "Bangladesh (+880)",
  BB: "Barbados (+1246)",
  BY: "Belarus (+375)",
  BE: "Belgium (+32)",
  BZ: "Belize (+501)",
  BJ: "Benin (+229)",
  BM: "Bermuda (+1441)",
  BT: "Bhutan (+975)",
  BO: "Bolivia (+591)",
  BA: "Bosnia and Herzegovina (+387)",
  BW: "Botswana (+267)",
  BR: "Brazil (+55)",
  BN: "Brunei (+673)",
  BG: "Bulgaria (+359)",
  BF: "Burkina Faso (+226)",
  BI: "Burundi (+257)",
  KH: "Cambodia (+855)",
  CM: "Cameroon (+237)",
  CA: "Canada (+1)",
  CV: "Cape Verde (+238)",
  KY: "Cayman Islands (+1345)",
  CF: "Central African Republic (+236)",
  TD: "Chad (+235)",
  CL: "Chile (+56)",
  CN: "China (+86)",
  CO: "Colombia (+57)",
  KM: "Comoros (+269)",
  CG: "Congo (+242)",
  CD: "Congo DR (+243)",
  CR: "Costa Rica (+506)",
  CI: "C√¥te d'Ivoire (+225)",
  HR: "Croatia (+385)",
  CU: "Cuba (+53)",
  CY: "Cyprus (+357)",
  CZ: "Czech Republic (+420)",
  DK: "Denmark (+45)",
  DJ: "Djibouti (+253)",
  DM: "Dominica (+1767)",
  DO: "Dominican Republic (+1809)",
  EC: "Ecuador (+593)",
  EG: "Egypt (+20)",
  SV: "El Salvador (+503)",
  GQ: "Equatorial Guinea (+240)",
  ER: "Eritrea (+291)",
  EE: "Estonia (+372)",
  ET: "Ethiopia (+251)",
  FJ: "Fiji (+679)",
  FI: "Finland (+358)",
  FR: "France (+33)",
  GF: "French Guiana (+594)",
  PF: "French Polynesia (+689)",
  GA: "Gabon (+241)",
  GM: "Gambia (+220)",
  GE: "Georgia (+995)",
  DE: "Germany (+49)",
  GH: "Ghana (+233)",
  GI: "Gibraltar (+350)",
  GR: "Greece (+30)",
  GL: "Greenland (+299)",
  GD: "Grenada (+1473)",
  GP: "Guadeloupe (+590)",
  GU: "Guam (+1671)",
  GT: "Guatemala (+502)",
  GN: "Guinea (+224)",
  GW: "Guinea-Bissau (+245)",
  GY: "Guyana (+592)",
  HT: "Haiti (+509)",
  HN: "Honduras (+504)",
  HK: "Hong Kong (+852)",
  HU: "Hungary (+36)",
  IS: "Iceland (+354)",
  IN: "India (+91)",
  ID: "Indonesia (+62)",
  IR: "Iran (+98)",
  IQ: "Iraq (+964)",
  IE: "Ireland (+353)",
  IL: "Israel (+972)",
  IT: "Italy (+39)",
  JM: "Jamaica (+1876)",
  JP: "Japan (+81)",
  JO: "Jordan (+962)",
  KZ: "Kazakhstan (+7)",
  KE: "Kenya (+254)",
  KI: "Kiribati (+686)",
  KW: "Kuwait (+965)",
  KG: "Kyrgyzstan (+996)",
  LA: "Laos (+856)",
  LV: "Latvia (+371)",
  LB: "Lebanon (+961)",
  LS: "Lesotho (+266)",
  LR: "Liberia (+231)",
  LY: "Libya (+218)",
  LI: "Liechtenstein (+423)",
  LT: "Lithuania (+370)",
  LU: "Luxembourg (+352)",
  MO: "Macao (+853)",
  MG: "Madagascar (+261)",
  MW: "Malawi (+265)",
  MY: "Malaysia (+60)",
  MV: "Maldives (+960)",
  ML: "Mali (+223)",
  MT: "Malta (+356)",
  MH: "Marshall Islands (+692)",
  MQ: "Martinique (+596)",
  MR: "Mauritania (+222)",
  MU: "Mauritius (+230)",
  MX: "Mexico (+52)",
  MD: "Moldova (+373)",
  MC: "Monaco (+377)",
  MN: "Mongolia (+976)",
  ME: "Montenegro (+382)",
  MS: "Montserrat (+1664)",
  MA: "Morocco (+212)",
  MZ: "Mozambique (+258)",
  MM: "Myanmar (+95)",
  NA: "Namibia (+264)",
  NR: "Nauru (+674)",
  NP: "Nepal (+977)",
  NL: "Netherlands (+31)",
  NC: "New Caledonia (+687)",
  NZ: "New Zealand (+64)",
  NI: "Nicaragua (+505)",
  NE: "Niger (+227)",
  NG: "Nigeria (+234)",
  KP: "North Korea (+850)",
  MK: "North Macedonia (+389)",
  NO: "Norway (+47)",
  OM: "Oman (+968)",
  PK: "Pakistan (+92)",
  PW: "Palau (+680)",
  PS: "Palestine (+970)",
  PA: "Panama (+507)",
  PG: "Papua New Guinea (+675)",
  PY: "Paraguay (+595)",
  PE: "Peru (+51)",
  PH: "Philippines (+63)",
  PL: "Poland (+48)",
  PT: "Portugal (+351)",
  PR: "Puerto Rico (+1787)",
  QA: "Qatar (+974)",
  RE: "Reunion (+262)",
  RO: "Romania (+40)",
  RU: "Russia (+7)",
  RW: "Rwanda (+250)",
  KN: "Saint Kitts and Nevis (+1869)",
  LC: "Saint Lucia (+1758)",
  VC: "Saint Vincent (+1784)",
  WS: "Samoa (+685)",
  SM: "San Marino (+378)",
  ST: "Sao Tome and Principe (+239)",
  SA: "Saudi Arabia (+966)",
  SN: "Senegal (+221)",
  RS: "Serbia (+381)",
  SC: "Seychelles (+248)",
  SL: "Sierra Leone (+232)",
  SG: "Singapore (+65)",
  SK: "Slovakia (+421)",
  SI: "Slovenia (+386)",
  SB: "Solomon Islands (+677)",
  SO: "Somalia (+252)",
  ZA: "South Africa (+27)",
  KR: "South Korea (+82)",
  SS: "South Sudan (+211)",
  ES: "Spain (+34)",
  LK: "Sri Lanka (+94)",
  SD: "Sudan (+249)",
  SR: "Suriname (+597)",
  SZ: "Swaziland (+268)",
  SE: "Sweden (+46)",
  CH: "Switzerland (+41)",
  SY: "Syria (+963)",
  TW: "Taiwan (+886)",
  TJ: "Tajikistan (+992)",
  TZ: "Tanzania (+255)",
  TH: "Thailand (+66)",
  TL: "Timor-Leste (+670)",
  TG: "Togo (+228)",
  TO: "Tonga (+676)",
  TT: "Trinidad and Tobago (+1868)",
  TN: "Tunisia (+216)",
  TR: "Turkey (+90)",
  TM: "Turkmenistan (+993)",
  TC: "Turks and Caicos (+1649)",
  TV: "Tuvalu (+688)",
  UG: "Uganda (+256)",
  UA: "Ukraine (+380)",
  AE: "United Arab Emirates (+971)",
  GB: "United Kingdom (+44)",
  US: "United States (+1)",
  UY: "Uruguay (+598)",
  UZ: "Uzbekistan (+998)",
  VU: "Vanuatu (+678)",
  VE: "Venezuela (+58)",
  VN: "Vietnam (+84)",
  YE: "Yemen (+967)",
  ZM: "Zambia (+260)",
  ZW: "Zimbabwe (+263)",
};
import {
  DndContext,
  closestCenter,
  KeyboardSensor,
  PointerSensor,
  useSensor,
  useSensors,
  DragEndEvent,
} from "@dnd-kit/core";
import {
  arrayMove,
  SortableContext,
  sortableKeyboardCoordinates,
  useSortable,
  verticalListSortingStrategy,
} from "@dnd-kit/sortable";
import { CSS } from "@dnd-kit/utilities";

// OpenAI Logo Component - Official Logomark geometry
const ChariowIcon = ({ className }: { className?: string }) => (
  <div className={`relative flex items-center justify-center ${className}`}>
    <img
      src="/chariow-logo.png"
      alt="Chariow"
      className="w-full h-full object-contain"
    />
  </div>
);

const OpenAIIcon = ({ className }: { className?: string }) => (
  <svg
    viewBox="0 0 24 24"
    fill="currentColor"
    className={className}
    xmlns="http://www.w3.org/2000/svg"
  >
    <path d="M22.2819 9.8211a5.9847 5.9847 0 0 0-.5157-4.9108 6.0462 6.0462 0 0 0-6.5098-2.9A6.0651 6.0651 0 0 0 4.9807 4.1818a5.9847 5.9847 0 0 0-3.9977 2.9 6.0462 6.0462 0 0 0 .7427 7.0966 5.98 5.98 0 0 0 .511 4.9107 6.051 6.051 0 0 0 6.5146 2.9001A5.9847 5.9847 0 0 0 13.2599 24a6.0557 6.0557 0 0 0 5.7718-4.2058 5.9894 5.9894 0 0 0 3.9977-2.9001 6.0557 6.0557 0 0 0-.7475-7.0729zm-9.022 12.6081a4.4755 4.4755 0 0 1-2.8764-1.0408l.1419-.0804 4.7783-2.7582a.7948.7948 0 0 0 .3927-.6813v-6.7369l2.02 1.1686a.071.071 0 0 1 .038.052v5.5826a4.504 4.504 0 0 1-4.4945 4.4944zm-9.6607-4.1254a4.4708 4.4708 0 0 1-.5346-3.0137l.142.0852 4.783 2.7582a.7712.7712 0 0 0 .7806 0l5.8428-3.3685v2.3324a.0804.0804 0 0 1-.0332.0615L9.74 19.9502a4.4992 4.4992 0 0 1-6.1408-1.6464zM2.3408 7.8956a4.485 4.485 0 0 1 2.3655-1.9728V11.6a.7664.7664 0 0 0 .3879.6765l5.8144 3.3543-2.0201 1.1685a.0757.0757 0 0 1-.071 0l-4.8303-2.7865A4.504 4.504 0 0 1 2.3408 7.872zm16.5963 3.8558L13.1038 8.364 15.1192 7.2a.0757.0757 0 0 1 .071 0l4.8303 2.7913a4.4944 4.4944 0 0 1-.6765 8.1042v-5.6772a.79.79 0 0 0-.407-.667zm2.0107-3.0231l-.142-.0852-4.7735-2.7818a.7759.7759 0 0 0-.7854 0L9.409 9.2297V6.8974a.0662.0662 0 0 1 .0284-.0615l4.8303-2.7866a4.4992 4.4992 0 0 1 6.6802 4.66zM8.3065 12.863l-2.02-1.1638a.0804.0804 0 0 1-.038-.0567V6.0742a4.4992 4.4992 0 0 1 7.3757-3.4537l-.142.0805L8.704 5.459a.7948.7948 0 0 0-.3927.6813zm1.0976-2.3654l2.602-1.4998 2.6069 1.4998v2.9994l-2.5974 1.4997-2.6067-1.4997Z" />
  </svg>
);

const TelegramIcon = ({ className }: { className?: string }) => (
  <svg
    viewBox="0 0 256 256"
    className={className}
    xmlns="http://www.w3.org/2000/svg"
    preserveAspectRatio="xMidYMid"
  >
    <g>
      <path
        d="M128,0 C57.307,0 0,57.307 0,128 L0,128 C0,198.693 57.307,256 128,256 L128,256 C198.693,256 256,198.693 256,128 L256,128 C256,57.307 198.693,0 128,0 L128,0 Z"
        fill="#44B6E4"
      ></path>
      <path
        d="M190.2826,73.6308 L167.4206,188.8978 C167.4206,188.8978 164.2236,196.8918 155.4306,193.0548 L102.6726,152.6068 L83.4886,143.3348 L51.1946,132.4628 C51.1946,132.4628 46.2386,130.7048 45.7586,126.8678 C45.2796,123.0308 51.3546,120.9528 51.3546,120.9528 L179.7306,70.5928 C179.7306,70.5928 190.2826,65.9568 190.2826,73.6308"
        fill="#FFFFFF"
      ></path>
      <path
        d="M98.6178,187.6035 C98.6178,187.6035 97.0778,187.4595 95.1588,181.3835 C93.2408,175.3085 83.4888,143.3345 83.4888,143.3345 L161.0258,94.0945 C161.0258,94.0945 165.5028,91.3765 165.3428,94.0945 C165.3428,94.0945 166.1418,94.5735 163.7438,96.8115 C161.3458,99.0505 102.8328,151.6475 102.8328,151.6475"
        fill="#D2E5F1"
      ></path>
      <path
        d="M122.9015,168.1154 L102.0335,187.1414 C102.0335,187.1414 100.4025,188.3794 98.6175,187.6034 L102.6135,152.2624"
        fill="#B5CFE4"
      ></path>
    </g>
  </svg>
);

const WhatsAppIcon = ({ className }: { className?: string }) => (
  <svg
    viewBox="0 0 48 48"
    className={className}
    xmlns="http://www.w3.org/2000/svg"
  >
    <g fill="none" fillRule="evenodd">
      <g transform="translate(-700, -360)" fill="#67C15E">
        <path d="M723.993033,360 C710.762252,360 700,370.765287 700,383.999801 C700,389.248451 701.692661,394.116025 704.570026,398.066947 L701.579605,406.983798 L710.804449,404.035539 C714.598605,406.546975 719.126434,408 724.006967,408 C737.237748,408 748,397.234315 748,384.000199 C748,370.765685 737.237748,360.000398 724.006967,360.000398 L723.993033,360.000398 L723.993033,360 Z M717.29285,372.190836 C716.827488,371.07628 716.474784,371.034071 715.769774,371.005401 C715.529728,370.991464 715.262214,370.977527 714.96564,370.977527 C714.04845,370.977527 713.089462,371.245514 712.511043,371.838033 C711.806033,372.557577 710.056843,374.23638 710.056843,377.679202 C710.056843,381.122023 712.567571,384.451756 712.905944,384.917648 C713.258648,385.382743 717.800808,392.55031 724.853297,395.471492 C730.368379,397.757149 732.00491,397.545307 733.260074,397.27732 C735.093658,396.882308 737.393002,395.527239 737.971421,393.891043 C738.54984,392.25405 738.54984,390.857171 738.380255,390.560912 C738.211068,390.264652 737.745308,390.095816 737.040298,389.742615 C736.335288,389.389811 732.90737,387.696673 732.25849,387.470894 C731.623543,387.231179 731.017259,387.315995 730.537963,387.99333 C729.860819,388.938653 729.198006,389.89831 728.661785,390.476494 C728.238619,390.928051 727.547144,390.984595 726.969123,390.744481 C726.193254,390.420348 724.021298,389.657798 721.340985,387.273388 C719.267356,385.42535 717.856938,383.125756 717.448104,382.434484 C717.038871,381.729275 717.405907,381.319529 717.729948,380.938852 C718.082653,380.501232 718.421026,380.191036 718.77373,379.781688 C719.126434,379.372738 719.323884,379.160897 719.549599,378.681068 C719.789645,378.215575 719.62006,377.735746 719.450874,377.382942 C719.281687,377.030139 717.871269,373.587317 717.29285,372.190836 Z" />
      </g>
    </g>
  </svg>
);

// Templates pr√©d√©finis pour les d√©butants
// Templates pr√©d√©finis pour les d√©butants
const workflowTemplates = [
  {
    id: "ecommerce",
    name: "Boutique Express",
    description:
      "Vendez vos produits avec catalogue, panier et paiement automatis√©.",
    icon: Store,
    color: "text-emerald-400",
    bg: "bg-emerald-400/10",
    popular: true,
    features: ["Catalogue AI", "Chariow Panier", "Paiement Auto"],
  },
  {
    id: "support",
    name: "Support Client IA",
    description: "R√©pondez instantan√©ment aux questions fr√©quentes 24h/7j.",
    icon: HeartHandshake,
    color: "text-blue-400",
    bg: "bg-blue-400/10",
    popular: true,
    features: ["FAQ IA", "Tickets Support", "Escalade Humain"],
  },
  {
    id: "appointment",
    name: "Prise de RDV",
    description: "Laissez vos clients r√©server des cr√©neaux sans intervention.",
    icon: Calendar,
    color: "text-purple-400",
    bg: "bg-purple-400/10",
    popular: true,
    features: ["Sync Calendrier", "Rappels Auto", "Confirmation"],
  },
  {
    id: "lead",
    name: "Capture de Leads",
    description: "Qualifiez vos prospects et collectez leurs informations.",
    icon: Target,
    color: "text-orange-400",
    bg: "bg-orange-400/10",
    popular: false,
    features: ["Questionnaire", "Scoring Leads", "Export CRM"],
  },
  {
    id: "marketing",
    name: "Flash Promo",
    description: "Envoyez des offres irr√©sistibles √† vos segments de clients.",
    icon: Megaphone,
    color: "text-pink-400",
    bg: "bg-pink-400/10",
    popular: false,
    features: ["Broadcasting", "Promo Codes", "Urgence IA"],
  },
  {
    id: "survey",
    name: "Avis & Satisfaction",
    description: "Collectez des avis clients automatiquement apr√®s un achat.",
    icon: Star,
    color: "text-yellow-400",
    bg: "bg-yellow-400/10",
    popular: false,
    features: ["Notation 1-5", "Commentaires", "Analyse Sentiment"],
  },
  {
    id: "abandon_cart",
    name: "Relance Panier",
    description:
      "R√©cup√©rez les ventes perdues en relan√ßant les paniers oubli√©s.",
    icon: ShoppingBag,
    color: "text-red-400",
    bg: "bg-red-400/10",
    popular: false,
    features: ["D√©tection Abandon", "Relance Douce", "Coupon Promo"],
  },
  {
    id: "tracking",
    name: "Suivi de Commande",
    description: "Informez vos clients sur l'√©tat de livraison de leurs colis.",
    icon: Truck,
    color: "text-indigo-400",
    bg: "bg-indigo-400/10",
    popular: false,
    features: ["Statut R√©el", "Lien Tracking", "Notifications"],
  },
  {
    id: "vip",
    name: "Club VIP / News",
    description:
      "Cr√©ez une liste de diffusion exclusive pour vos meilleurs clients.",
    icon: Mail,
    color: "text-cyan-400",
    bg: "bg-cyan-400/10",
    popular: false,
    features: ["Abonnement", "Contenu Exclusif", "D√©sinscription"],
  },
  {
    id: "quote",
    name: "Devis Rapide",
    description:
      "G√©n√©rez des devis personnalis√©s en posant les bonnes questions.",
    icon: FileText,
    color: "text-slate-400",
    bg: "bg-slate-400/10",
    popular: false,
    features: ["Collecte Specs", "Calcul Prix", "Envoi PDF"],
  },
  {
    id: "contest",
    name: "Jeu Concours",
    description: "Animez votre communaut√© avec un concours WhatsApp viral.",
    icon: Trophy,
    color: "text-amber-500",
    bg: "bg-amber-500/10",
    popular: false,
    features: ["Inscription", "Tirage Sort", "Annonce Gagnant"],
  },
  {
    id: "education",
    name: "Micro-Formation",
    description: "D√©livrez du contenu √©ducatif √©tape par √©tape sur WhatsApp.",
    icon: BookOpen,
    color: "text-emerald-500",
    bg: "bg-emerald-500/10",
    popular: false,
    features: ["Le√ßons Auto", "Quiz IA", "Certificat"],
  },
  {
    id: "hr",
    name: "Recrutement RH",
    description: "Filtrez les candidatures et planifiez les entretiens.",
    icon: Briefcase,
    color: "text-blue-500",
    bg: "bg-blue-500/10",
    popular: false,
    features: ["D√©p√¥t CV", "Questions Filtres", "RDV RH"],
  },
  {
    id: "restaurant",
    name: "Menu & R√©sa Resto",
    description: "Affichez votre carte et prenez des r√©servations de table.",
    icon: Utensils,
    color: "text-orange-500",
    bg: "bg-orange-500/10",
    popular: false,
    features: ["Menu Digital", "Dispo Table", "Confirmation"],
  },
  {
    id: "stock",
    name: "Alerte Stock",
    description:
      "Pr√©venez les clients quand un produit est de retour en stock.",
    icon: Box,
    color: "text-zinc-400",
    bg: "bg-zinc-400/10",
    popular: false,
    features: ["Waitlist", "Notif Retour", "Lien Achat"],
  },
  {
    id: "enterprise",
    name: "Enterprise 360¬∞",
    description:
      "Workflow complet avec routage intelligent, support et checkout.",
    icon: Rocket,
    color: "text-violet-400",
    bg: "bg-violet-400/10",
    popular: true,
    features: ["Multi-Agents", "Support N3", "Full CRM"],
  },
  {
    id: "agency",
    name: "Agence Digital Pro",
    description: "De la prise de brief √† la signature du devis automatis√©e.",
    icon: Cpu,
    color: "text-amber-400",
    bg: "bg-amber-400/10",
    popular: false,
    features: ["Roadmap Auto", "Consulting IA", "Devis PDF"],
  },
  {
    id: "hr_pro",
    name: "RH Master Pipeline",
    description: "Processus de recrutement complet : screening, tests et RDV.",
    icon: ShieldCheck,
    color: "text-emerald-400",
    bg: "bg-emerald-400/10",
    popular: false,
    features: ["Tests Soft Skills", "Scoring IA", "Calendly Sync"],
  },
  {
    id: "custom",
    name: "Workflow Vide",
    description: "D√©marrez avec une page blanche et cr√©ez sans limites.",
    icon: Wand2,
    color: "text-primary",
    bg: "bg-primary/10",
    popular: false,
    features: ["Sur Mesure", "Tous les Blocs", "Mode Expert"],
  },
];

// Cat√©gories de n≈ìuds pour les automatisations
const nodeCategories = [
  {
    id: "triggers",
    name: "D√©clencheurs",
    icon: Zap,
    nodes: [
      {
        id: "whatsapp_message",
        name: "WhatsApp re√ßu",
        icon: WhatsAppIcon,
        description: "Quand un message WhatsApp arrive",
      },
      {
        id: "telegram_message",
        name: "Telegram re√ßu",
        icon: TelegramIcon,
        description: "Quand un message Telegram arrive",
      },
      {
        id: "keyword",
        name: "Mot-cl√© d√©tect√©",
        icon: Target,
        description: "D√©clenche sur des mots sp√©cifiques",
      },
      {
        id: "new_contact",
        name: "Nouveau contact",
        icon: Users,
        description: "Premier message d'un nouveau client",
      },
      {
        id: "scheduled",
        name: "Programm√©",
        icon: Clock,
        description: "D√©clenche √† une heure pr√©cise",
      },
      {
        id: "webhook_trigger",
        name: "Webhook entrant",
        icon: Globe,
        description: "D√©clenche via un appel API externe",
      },
    ],
  },
  {
    id: "ai",
    name: "Intelligence IA",
    icon: OpenAIIcon,
    nodes: [
      {
        id: "gpt_analyze",
        name: "Analyser intention",
        icon: OpenAIIcon,
        description: "L'IA comprend ce que veut le client",
      },
      {
        id: "gpt_respond",
        name: "R√©ponse IA",
        icon: OpenAIIcon,
        description: "G√©n√®re une r√©ponse personnalis√©e avec GPT",
      },
      {
        id: "sentiment",
        name: "Analyse sentiment",
        icon: HeartHandshake,
        description: "D√©tecte si le client est satisfait ou frustr√©",
      },
      {
        id: "ai_translate",
        name: "Traduction auto",
        icon: Globe,
        description: "Traduit automatiquement les messages",
      },
      {
        id: "ai_summarize",
        name: "R√©sumer conversation",
        icon: FileText,
        description: "Cr√©e un r√©sum√© de la conversation",
      },
    ],
  },
  {
    id: "ecommerce",
    name: "E-Commerce",
    icon: ShoppingCart,
    nodes: [
      {
        id: "show_catalog",
        name: "Envoyer Catalogue",
        icon: Package,
        description: "Affiche la liste de vos produits",
      },
      {
        id: "add_to_cart",
        name: "Ajouter au panier",
        icon: ShoppingCart,
        description: "D√©tecte et ajoute un produit au panier",
      },
      {
        id: "show_cart",
        name: "Afficher panier",
        icon: ShoppingBag,
        description: "Montre le contenu du panier actuel",
      },
      {
        id: "checkout",
        name: "Passer commande",
        icon: CreditCard,
        description: "Finalise la commande et envoie le paiement",
      },
      {
        id: "order_status",
        name: "Suivi commande",
        icon: Truck,
        description: "Donne l'√©tat d'une commande en cours",
      },
      {
        id: "apply_promo",
        name: "Code promo",
        icon: Trophy,
        description: "Applique une r√©duction au panier",
      },
    ],
  },
  {
    id: "messages",
    name: "Messages",
    icon: Send,
    nodes: [
      {
        id: "send_text",
        name: "Envoyer texte",
        icon: MessageSquare,
        description: "Envoie un message texte personnalis√©",
      },
      {
        id: "send_image",
        name: "Envoyer image",
        icon: Image,
        description: "Envoie une image ou photo",
      },
      {
        id: "send_document",
        name: "Envoyer document",
        icon: FileText,
        description: "Envoie un PDF, facture ou fichier",
      },
      {
        id: "send_location",
        name: "Envoyer localisation",
        icon: MapPin,
        description: "Partage votre adresse/position GPS",
      },
      {
        id: "send_contact",
        name: "Envoyer contact",
        icon: Contact2,
        description: "Partage une fiche contact VCard",
      },
      {
        id: "send_audio",
        name: "Envoyer audio",
        icon: Mic,
        description: "Envoie un message vocal",
      },
      {
        id: "send_buttons",
        name: "Menu √† choix",
        icon: ListChecks,
        description: "Propose des options cliquables",
      },
      {
        id: "tg_buttons",
        name: "Boutons Telegram",
        icon: TelegramIcon,
        description: "Boutons interactifs pour Telegram",
      },
    ],
  },
  {
    id: "logic",
    name: "Logique & Flux",
    icon: GitBranch,
    nodes: [
      {
        id: "condition",
        name: "Condition Si/Sinon",
        icon: GitBranch,
        description: "Branche selon une condition",
      },
      {
        id: "delay",
        name: "Attendre",
        icon: Clock,
        description: "Pause avant la prochaine action",
      },
      {
        id: "loop",
        name: "Boucle",
        icon: Zap,
        description: "R√©p√®te une s√©quence d'actions",
      },
      {
        id: "set_variable",
        name: "D√©finir variable",
        icon: Box,
        description: "Stocke une valeur pour l'utiliser plus tard",
      },
      {
        id: "random_choice",
        name: "Choix al√©atoire",
        icon: Sparkles,
        description: "Choisit al√©atoirement une branche",
      },
      {
        id: "end_flow",
        name: "Fin du flux",
        icon: X,
        description: "Termine l'automatisation ici",
      },
    ],
  },
  {
    id: "crm",
    name: "CRM & Contacts",
    icon: Users,
    nodes: [
      {
        id: "save_contact",
        name: "Sauvegarder contact",
        icon: UserPlus,
        description: "Enregistre le client dans votre CRM",
      },
      {
        id: "add_tag",
        name: "Ajouter tag",
        icon: Target,
        description: "Tagge le contact (ex: 'VIP', 'Prospect')",
      },
      {
        id: "remove_tag",
        name: "Retirer tag",
        icon: UserMinus,
        description: "Retire un tag du contact",
      },
      {
        id: "update_contact",
        name: "Modifier contact",
        icon: Users,
        description: "Met √† jour les infos du contact",
      },
      {
        id: "assign_agent",
        name: "Assigner agent",
        icon: HeartHandshake,
        description: "Transf√®re la conversation √† un humain",
      },
      {
        id: "add_note",
        name: "Ajouter note",
        icon: FileText,
        description: "Ajoute une note interne sur le contact",
      },
    ],
  },
  {
    id: "notifications",
    name: "Notifications",
    icon: Bell,
    nodes: [
      {
        id: "notify_email",
        name: "Email notification",
        icon: Mail,
        description: "Envoie un email √† votre √©quipe",
      },
      {
        id: "notify_webhook",
        name: "Webhook sortant",
        icon: Globe,
        description: "Appelle une URL externe (Zapier, Make...)",
      },
      {
        id: "notify_slack",
        name: "Notification Slack",
        icon: MessageSquare,
        description: "Envoie un message dans un canal Slack",
      },
      {
        id: "notify_internal",
        name: "Alerte interne",
        icon: Bell,
        description: "Notification dans votre tableau de bord",
      },
    ],
  },
  {
    id: "calendar",
    name: "Rendez-vous",
    icon: Calendar,
    nodes: [
      {
        id: "check_availability",
        name: "V√©rifier disponibilit√©",
        icon: Calendar,
        description: "Affiche les cr√©neaux libres",
      },
      {
        id: "book_appointment",
        name: "R√©server RDV",
        icon: Check,
        description: "Cr√©e un rendez-vous dans l'agenda",
      },
      {
        id: "cancel_appointment",
        name: "Annuler RDV",
        icon: X,
        description: "Annule un rendez-vous existant",
      },
      {
        id: "send_reminder",
        name: "Rappel RDV",
        icon: Bell,
        description: "Envoie un rappel avant le rendez-vous",
      },
    ],
  },
  {
    id: "security",
    name: "S√©curit√©",
    icon: ShieldCheck,
    nodes: [
      {
        id: "anti_ban",
        name: "D√©lai Anti-Ban",
        icon: ShieldCheck,
        description: "D√©lai al√©atoire pour √©viter les bans",
      },
      {
        id: "rate_limit",
        name: "Limite de messages",
        icon: Clock,
        description: "Limite le nombre de messages par minute",
      },
      {
        id: "block_spam",
        name: "Bloquer spam",
        icon: UserX,
        description: "Bloque les contacts qui spamment",
      },
      {
        id: "verify_human",
        name: "V√©rification humain",
        icon: HelpCircle,
        description: "Pose une question simple anti-bot",
      },
    ],
  },
  {
    id: "groups",
    name: "Groupes WhatsApp",
    icon: Users,
    nodes: [
      {
        id: "create_group",
        name: "Cr√©er groupe",
        icon: PlusCircle,
        description: "Cr√©e un nouveau groupe WhatsApp",
      },
      {
        id: "add_participant",
        name: "Ajouter membre",
        icon: UserPlus,
        description: "Ajoute un contact au groupe",
      },
      {
        id: "remove_participant",
        name: "Retirer membre",
        icon: UserX,
        description: "Retire un membre du groupe",
      },
      {
        id: "group_announcement",
        name: "Mode annonce",
        icon: Megaphone,
        description: "Seuls les admins peuvent √©crire",
      },
      {
        id: "bulk_add_members",
        name: "Ajout massif",
        icon: Users,
        description: "Ajoute plusieurs membres d'un coup",
      },
    ],
  },
  {
    id: "extraction",
    name: "Extraction & Data",
    icon: Search,
    nodes: [
      {
        id: "get_group_members",
        name: "Extraire membres",
        icon: UserSearch,
        description: "R√©cup√®re la liste des membres d'un groupe",
      },
      {
        id: "google_maps_extract",
        name: "Leads Google Maps",
        icon: Map,
        description: "Extrait des contacts pros depuis Google Maps",
      },
      {
        id: "group_link_finder",
        name: "Trouver groupes",
        icon: Link2,
        description: "Recherche des liens de groupes sur le web",
      },
      {
        id: "chat_list_collector",
        name: "Liste conversations",
        icon: ListChecks,
        description: "R√©cup√®re toutes vos discussions",
      },
      {
        id: "web_email_extract",
        name: "Extracteur web",
        icon: Globe,
        description: "Extrait emails et num√©ros depuis un site",
      },
    ],
  },
  {
    id: "advanced",
    name: "Avanc√©",
    icon: Cpu,
    nodes: [
      {
        id: "http_request",
        name: "Requ√™te HTTP",
        icon: Globe,
        description: "Appelle une API externe (GET/POST)",
      },
      {
        id: "run_javascript",
        name: "Code JavaScript",
        icon: Cpu,
        description: "Ex√©cute du code personnalis√©",
      },
      {
        id: "google_sheets",
        name: "Google Sheets",
        icon: FileText,
        description: "Lit ou √©crit dans une feuille Google",
      },
      {
        id: "database_query",
        name: "Base de donn√©es",
        icon: Box,
        description: "Requ√™te SQL personnalis√©e",
      },
    ],
  },
  {
    id: "marketing",
    name: "Marketing Pro",
    icon: Megaphone,
    nodes: [
      {
        id: "number_filter",
        name: "Filtre num√©ros",
        icon: Filter,
        description: "V√©rifie quels num√©ros ont WhatsApp",
      },
      {
        id: "whatsapp_warmer",
        name: "Warm-up compte",
        icon: Flame,
        description: "Pr√©pare votre compte pour les campagnes",
      },
      {
        id: "mass_group_gen",
        name: "G√©n√©rateur groupes",
        icon: LayoutTemplate,
        description: "Cr√©e plusieurs groupes automatiquement",
      },
    ],
  },
];

// Produits exemple pour le catalogue
const sampleProducts = [
  {
    id: 1,
    name: "iPhone 15 Pro",
    price: 999,
    image: "üì±",
    stock: 50,
    labels: ["Apple", "Mobile"],
    description: "Le dernier smartphone d'Apple avec processeur A17 Pro.",
  },
  {
    id: 2,
    name: "MacBook Air M3",
    price: 1299,
    image: "üíª",
    stock: 30,
    labels: ["Apple", "PC"],
    description: "Ordinateur ultra-portable et puissant.",
  },
  {
    id: 3,
    name: "AirPods Pro 2",
    price: 249,
    image: "üéß",
    stock: 100,
    labels: ["Audio", "Premium"],
    description: "R√©duction de bruit active et son spatial.",
  },
];

type Product = {
  id: number;
  name: string;
  description: string;
  price: number;
  image: string;
  stock: number;
  labels: string[];
};

const currencySymbols: Record<string, string> = {
  USD: "$",
  EUR: "‚Ç¨",
  XOF: "XOF",
  CAD: "CAD$",
};

type ViewMode = "templates" | "builder" | "ai-assist" | "products";

type WorkflowNode = {
  id: number;
  type: string;
  name: string;
  config: string;
  x: number;
  y: number;
  connectedTo?: number;
};

// Free-form Draggable Node Component (n8n style)
function DraggableNode({
  node,
  nodeInfo,
  onDelete,
  onPositionChange,
  isSelected,
  onSelect,
  onNodeSelectOnly,
  onOpenSettings,
  zoom,
  isActiveStep,
  executionStatus,
  onStartConnect,
  onCompleteConnect,
  onAddNext,
  isConnecting,
  isStartingConnection,
  isTargetable,
  isDisconnected,
  isWhatsAppConnected,
}: {
  node: WorkflowNode;
  nodeInfo: any;
  onDelete: () => void;
  onPositionChange: (
    id: number,
    deltaX: number,
    deltaY: number,
    isSelected: boolean,
  ) => void;
  isSelected?: boolean;
  isActiveStep?: boolean;
  executionStatus?: "success" | "error" | "warning" | "skipped" | "running";
  onSelect: (e: React.MouseEvent) => void;
  onNodeSelectOnly: (e: React.MouseEvent) => void;
  onOpenSettings: () => void;
  zoom: number;
  onStartConnect?: () => void;
  onCompleteConnect?: () => void;
  onAddNext?: () => void;
  isConnecting?: boolean;
  isStartingConnection?: boolean;
  isTargetable?: boolean;
  isDisconnected?: boolean;
  isWhatsAppConnected?: boolean;
}) {
  const [showToolbar, setShowToolbar] = useState(false);
  const [isDragging, setIsDragging] = useState(false);

  // Determine node color based on category
  const getCategoryColor = () => {
    if (node.type === "chariow")
      return {
        bg: "bg-[#E0E0E0]",
        border: "border-orange-500/30",
        text: "text-orange-400",
      };
    if (!nodeInfo?.category?.id)
      return {
        bg: "bg-[#1a1a1a]",
        border: "border-[#87a9ff]/30",
        text: "text-[#87a9ff]",
      };
    switch (nodeInfo.category.id) {
      case "triggers":
        return {
          bg: "bg-[#1a1a1a]",
          border: "border-emerald-500/30",
          text: "text-emerald-400",
        };
      case "ai":
        return {
          bg: "bg-[#000000]",
          border: "border-[#10a37f]/50",
          text: "text-white",
        };
      case "ecommerce":
        return {
          bg: "bg-[#1a1a1a]",
          border: "border-orange-500/30",
          text: "text-orange-400",
        };
      case "messages":
        return {
          bg: "bg-[#1a1a1a]",
          border: "border-blue-500/30",
          text: "text-blue-400",
        };
      case "logic":
        return {
          bg: "bg-[#1a1a1a]",
          border: "border-pink-500/30",
          text: "text-pink-400",
        };
      default:
        return {
          bg: "bg-[#1a1a1a]",
          border: "border-[#87a9ff]/30",
          text: "text-[#87a9ff]",
        };
    }
  };

  const colors = getCategoryColor();

  // Configuration check logic
  const isUnconfigured = (() => {
    try {
      const config = JSON.parse(node.config);
      const type = node.type;

      if (type === "gpt_analyze" || type === "gpt_respond") {
        return !config.system && !config.aiInstructions;
      }
      if (
        type === "whatsapp_message" ||
        type === "telegram_message" ||
        type === "send_text" ||
        type === "send_image"
      ) {
        return !config.aiInstructions && !config.text && !config.imageUrl;
      }
      if (type === "keyword") {
        return !config.keywords && !config.aiInstructions;
      }
      if (type === "chariow") {
        return (
          !config.storeUrl && !config.storeDomain && !config.aiInstructions
        );
      }
      if (type === "calendar") {
        return !config.calendarId;
      }
      if (type === "condition") {
        return !config.condition;
      }
      if (type === "clock" || type === "delay") {
        return !config.delay && !config.time;
      }
      if (type === "trigger") {
        return !config.event && !config.type;
      }
      if (type === "sentiment" || type === "bulk_add_members") {
        return !config.aiInstructions;
      }

      // Default check for others
      return Object.keys(config).length === 0;
    } catch {
      return true;
    }
  })();

  const isWhatsAppAlert =
    node.type === "whatsapp_message" && !isWhatsAppConnected;

  return (
    <motion.div
      key={node.id}
      onPan={(_, info) => {
        // Precision pan logic: update state directly, no transform conflicts
        onPositionChange(
          node.id,
          info.delta.x / zoom,
          info.delta.y / zoom,
          !!isSelected,
        );
      }}
      onPanStart={() => setIsDragging(true)}
      onPanEnd={() => setIsDragging(false)}
      onDoubleClick={onSelect}
      onClick={(e) => {
        // Single click selects but doesn't open panel
        onNodeSelectOnly(e);
      }}
      onMouseEnter={() => setShowToolbar(true)}
      onMouseLeave={() => setShowToolbar(false)}
      onMouseDown={(e) => e.stopPropagation()}
      className={`absolute flex flex-col items-center cursor-grab active:cursor-grabbing group node-element ${isSelected ? "z-50" : "z-10"}`}
      style={{
        left: node.x,
        top: node.y,
        width: 96,
      }}
    >
      {/* Premium Focus Aura & Industrial Brackets */}
      <AnimatePresence>
        {(isSelected || isActiveStep) && (
          <>
            {/* Precision Corner Brackets */}
            <motion.div
              key="selection-brackets"
              initial={{ opacity: 0, scale: 1.2 }}
              animate={{ opacity: 1, scale: isActiveStep ? 1.1 : 1 }}
              exit={{ opacity: 0, scale: 1.2 }}
              className="absolute -inset-4 pointer-events-none"
            >
              <div
                className={`absolute top-0 left-0 w-3 h-3 border-t-2 border-l-2 rounded-tl-sm transition-colors ${isActiveStep ? "border-primary" : "border-primary/60"}`}
              />
              <div
                className={`absolute top-0 right-0 w-3 h-3 border-t-2 border-r-2 rounded-tr-sm transition-colors ${isActiveStep ? "border-primary" : "border-primary/60"}`}
              />
              <div
                className={`absolute bottom-0 left-0 w-3 h-3 border-b-2 border-l-2 rounded-bl-sm transition-colors ${isActiveStep ? "border-primary" : "border-primary/60"}`}
              />
              <div
                className={`absolute bottom-0 right-0 w-3 h-3 border-b-2 border-r-2 rounded-br-sm transition-colors ${isActiveStep ? "border-primary" : "border-primary/60"}`}
              />
            </motion.div>
          </>
        )}
      </AnimatePresence>

      {/* Execution Status Feedback */}
      <AnimatePresence>
        {executionStatus && (
          <motion.div
            key="execution-status"
            initial={{ opacity: 0, scale: 1.5 }}
            animate={{
              opacity: 1,
              scale: 1,
              x: executionStatus === "error" ? [0, -3, 3, -3, 3, 0] : 0,
            }}
            exit={{ opacity: 0, scale: 0.8 }}
            transition={{ duration: 0.3 }}
            className={`absolute inset-0 -z-10 rounded-2xl pointer-events-none
                            ${executionStatus === "success" ? "ring-4 ring-emerald-500/60 shadow-[0_0_30px_rgba(16,185,129,0.5)]" : ""}
                            ${executionStatus === "error" ? "ring-4 ring-red-500/80 shadow-[0_0_40px_rgba(239,68,68,0.6)]" : ""}
                            ${executionStatus === "warning" ? "ring-4 ring-orange-500/60 shadow-[0_0_25px_rgba(249,115,22,0.5)]" : ""}
                            ${executionStatus === "skipped" ? "ring-2 ring-zinc-500/40" : ""}
                            ${executionStatus === "running" ? "ring-4 ring-blue-500/80 shadow-[0_0_40px_rgba(59,130,246,0.7)] animate-pulse" : ""}
                        `}
          />
        )}
      </AnimatePresence>
      {/* Hover Toolbar */}
      <AnimatePresence>
        {(showToolbar || isSelected) && (
          <motion.div
            initial={{ opacity: 0, y: 5 }}
            animate={{ opacity: 1, y: 0 }}
            exit={{ opacity: 0, y: 5 }}
            className="absolute -top-12 left-1/2 -translate-x-1/2 z-30"
          >
            <div className="flex items-center gap-1 px-2 py-1.5 rounded-lg bg-[#1f1f1f] border border-white/10 shadow-xl">
              <button
                className="h-7 w-7 rounded-md hover:bg-white/10 flex items-center justify-center text-muted-foreground hover:text-white transition-colors"
                title="Ex√©cuter"
              >
                <Play className="h-3 w-3" />
              </button>
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  onOpenSettings();
                }}
                className="h-7 w-7 rounded-md hover:bg-white/10 flex items-center justify-center text-muted-foreground hover:text-white transition-colors"
                title="Param√®tres"
              >
                <Settings className="h-3 w-3" />
              </button>
              <div className="w-px h-4 bg-white/10 mx-0.5" />
              <button
                onClick={(e) => {
                  e.stopPropagation();
                  onDelete();
                }}
                className="h-7 w-7 rounded-md hover:bg-red-500/10 flex items-center justify-center text-muted-foreground hover:text-red-500 transition-colors"
                title="Supprimer"
              >
                <Trash2 className="h-3 w-3" />
              </button>
            </div>
          </motion.div>
        )}
      </AnimatePresence>

      {/* Main Node Box - n8n style */}
      <div
        className={`
                    relative w-24 h-24
                    ${nodeInfo?.category?.id === "triggers"
            ? "rounded-tl-[40px] rounded-br-[40px] rounded-tr-xl rounded-bl-xl"
            : "rounded-2xl"
          }
                    ${colors.bg} ${colors.border} border-2
                    flex items-center justify-center
                    ${isSelected ? "ring-2 ring-primary ring-offset-2 ring-offset-background" : ""}
                    ${isActiveStep ? "glow-active scale-105" : ""}
                    hover:shadow-lg transition-all duration-200
                `}
      >
        {/* Icon */}
        <div className={`${colors.text}`}>
          {nodeInfo && (
            <nodeInfo.icon
              className={node.type === "chariow" ? "h-16 w-16" : "h-10 w-10"}
            />
          )}
        </div>

        {/* Status Indicator Dot (n8n style) */}
        {executionStatus && (
          <div className={`absolute -top-1 -right-1 h-4 w-4 rounded-full border-2 border-background flex items-center justify-center
             ${executionStatus === 'success' ? 'bg-emerald-500' : ''}
             ${executionStatus === 'error' ? 'bg-red-500' : ''}
             ${executionStatus === 'warning' ? 'bg-orange-500' : ''}
             ${executionStatus === 'skipped' ? 'bg-zinc-500' : ''}
             ${executionStatus === 'running' ? 'bg-blue-500 animate-pulse' : ''}
           `}>
            {executionStatus === 'success' && <Check className="h-2.5 w-2.5 text-white" />}
            {executionStatus === 'error' && <X className="h-2.5 w-2.5 text-white" />}
            {executionStatus === 'running' && <Loader2 className="h-2.5 w-2.5 text-white animate-spin" />}
          </div>
        )}

        {/* Connection Input Handle (left side) */}
        <div
          className="absolute left-0 top-1/2 -translate-x-1/2 -translate-y-1/2 z-20 cursor-pointer"
          onClick={(e) => {
            e.stopPropagation();
            if (isTargetable && onCompleteConnect) {
              onCompleteConnect();
            }
          }}
        >
          <div
            className={`h-4 w-4 rounded-full bg-[#252525] border-2 transition-all
                        ${isTargetable ? "border-emerald-400 scale-125 animate-pulse" : "border-zinc-600"}
                        hover:border-emerald-400 hover:scale-125
                    `}
          />
        </div>

        {/* Connection Output Handle (right side) */}
        <div
          className="absolute right-0 top-1/2 translate-x-1/2 -translate-y-1/2 z-20 cursor-pointer"
          onClick={(e) => {
            e.stopPropagation();
            if (onStartConnect) {
              onStartConnect();
            }
          }}
        >
          <div
            className={`h-4 w-4 rounded-full bg-[#252525] border-2 transition-all
                        ${isDisconnected && !isStartingConnection ? "border-orange-400" : "border-zinc-600"}
                        ${isStartingConnection ? "border-emerald-400 scale-125 animate-pulse" : ""}
                        hover:border-[#87a9ff] hover:scale-125
                    `}
          />
        </div>
      </div>

      {/* Label Below Node (n8n 2.0 style) */}
      <div className="mt-2 text-center w-[120px]">
        <h4 className="text-[11px] font-black text-white uppercase tracking-tighter truncate leading-none mb-1">
          {node.name}
        </h4>
        <span className="text-[8px] font-bold text-white/30 uppercase tracking-widest truncate">
          {nodeInfo?.category?.name || "Action"}
        </span>
      </div>

      {/* Plus Button (appears on hover) - shifted to avoid overlapping the handle */}
      <div
        className={`absolute right-0 top-1/2 -translate-y-1/2 z-10 flex items-center transition-opacity duration-200 ${showToolbar || isSelected ? "opacity-100" : "opacity-0"}`}
        style={{ right: "-45px" }}
      >
        <div className="w-4 h-0.5 bg-zinc-600" />
        <button
          onClick={(e) => {
            e.stopPropagation();
            if (onAddNext) onAddNext();
          }}
          className="h-6 w-6 rounded-md bg-[#252525] border border-zinc-600 hover:border-[#87a9ff] hover:bg-[#87a9ff]/10 flex items-center justify-center text-zinc-500 hover:text-[#87a9ff] transition-all shadow-xl"
        >
          <Plus className="h-3 w-3" />
        </button>
      </div>
    </motion.div>
  );
}

export default function NewWorkflowPage() {
  const [viewMode, setViewMode] = useState<ViewMode>("templates");
  const [selectedTemplate, setSelectedTemplate] = useState<string | null>(null);
  const [workflowName, setWorkflowName] = useState("Mon Workflow");
  const [automationId, setAutomationId] = useState("");
  const [nodes, setNodes] = useState<Array<WorkflowNode>>([]);
  const [executionLogs, setExecutionLogs] = useState<any[]>([]);
  const [tgBotToken, setTgBotToken] = useState("");
  const [userPhoneNumber, setUserPhoneNumber] = useState("");
  const [isPhoneSubmitted, setIsPhoneSubmitted] = useState(false);
  const isTelegramWorkflow = nodes.some(
    (n) => n.type === "telegram_message" || n.type === "tg_buttons",
  );
  const isLoaded = React.useRef(false);

  // Persistence: Load on mount
  useEffect(() => {
    const savedName = localStorage.getItem("draft_workflow_name");
    const savedId = localStorage.getItem("draft_automation_id");
    const savedNodes = localStorage.getItem("draft_workflow_nodes");

    if (savedName) setWorkflowName(savedName);
    if (savedId) {
      setAutomationId(savedId);
    } else {
      const newId = `auto_${Math.random().toString(36).substr(2, 9)}`;
      setAutomationId(newId);
      localStorage.setItem("draft_automation_id", newId);
    }
    if (savedNodes) {
      try {
        setNodes(JSON.parse(savedNodes));
      } catch (e) {
        console.error("Failed to parse nodes", e);
      }
    }
    const savedLogs = localStorage.getItem("draft_execution_logs");
    if (savedLogs) {
      try {
        setExecutionLogs(JSON.parse(savedLogs));
      } catch (e) {
        console.error("Failed to parse logs", e);
      }
    }
    const savedTgToken = localStorage.getItem("draft_tg_token");
    if (savedTgToken) setTgBotToken(savedTgToken);

    isLoaded.current = true;
  }, []);

  // Persistence: Save on change
  useEffect(() => {
    if (!isLoaded.current) return;
    localStorage.setItem("draft_workflow_name", workflowName);
  }, [workflowName]);

  useEffect(() => {
    if (!isLoaded.current) return;
    localStorage.setItem("draft_workflow_nodes", JSON.stringify(nodes));
  }, [nodes]);

  useEffect(() => {
    if (!isLoaded.current) return;
    localStorage.setItem("draft_execution_logs", JSON.stringify(executionLogs));
  }, [executionLogs]);

  useEffect(() => {
    if (!isLoaded.current) return;
    localStorage.setItem("draft_tg_token", tgBotToken);
  }, [tgBotToken]);

  const [rightPanelTab, setRightPanelTab] = useState<
    "inspect" | "simulate" | "logs"
  >("simulate");
  const [aiPrompt, setAiPrompt] = useState("");
  const [expandedCategory, setExpandedCategory] = useState<string | null>(
    "triggers",
  );
  const [products, setProducts] = useState<Product[]>(sampleProducts);
  const [selectedNodeIds, setSelectedNodeIds] = useState<Set<number>>(
    new Set(),
  );
  const [zoom, setZoom] = useState(0.8); // Default zoom 80%
  const [isRightPanelOpen, setIsRightPanelOpen] = useState(false);
  const [isWhatsAppConnected, setIsWhatsAppConnected] = useState(false); // Instance Admin/Simulateur
  const [isClientWhatsAppConnected, setIsClientWhatsAppConnected] =
    useState(false); // Instance Client
  const [clientWhatsAppNumber, setClientWhatsAppNumber] = useState<
    string | null
  >(null);
  const [isDisconnectingWhatsApp, setIsDisconnectingWhatsApp] =
    useState(false);
  const [showPublishModal, setShowPublishModal] = useState(false);
  const [showConnectionModal, setShowConnectionModal] = useState(false);
  const [userAutomations, setUserAutomations] = useState<any[]>([]);
  const [isLoadingUserAutomations, setIsLoadingUserAutomations] =
    useState(false);

  // Fetch user automations on mount
  useEffect(() => {
    const fetchUserAutomations = async () => {
      setIsLoadingUserAutomations(true);
      try {
        const response = await fetch("/api/automations");
        const data = await response.json();
        if (data.success) {
          setUserAutomations(data.automations);
        }
      } catch (error) {
        console.error("Error fetching user automations:", error);
      } finally {
        setIsLoadingUserAutomations(false);
      }
    };

    fetchUserAutomations();
  }, []);

  const [selectionRect, setSelectionRect] = useState<{
    x1: number;
    y1: number;
    x2: number;
    y2: number;
  } | null>(null);
  const [isSelecting, setIsSelecting] = useState(false);
  const [nodePickerPos, setNodePickerPos] = useState<{
    x: number;
    y: number;
    index: number;
  } | null>(null);

  const handleLoadUserAutomation = async (id: string) => {
    setIsSaving(true); // Show loader
    try {
      const response = await fetch(`/api/automations/${id}`);
      const data = await response.json();
      if (data.success && data.automation) {
        setAutomationId(data.automation.id);
        setWorkflowName(data.automation.name);
        if (data.automation.nodes) {
          setNodes(
            typeof data.automation.nodes === "string"
              ? JSON.parse(data.automation.nodes)
              : data.automation.nodes,
          );
        }
        if (data.automation.products) {
          setProducts(
            typeof data.automation.products === "string"
              ? JSON.parse(data.automation.products)
              : data.automation.products,
          );
        }
        setSelectedTemplate(data.automation.template);
        setViewMode("builder");
      }
    } catch (error) {
      console.error("Error loading user automation:", error);
    } finally {
      setIsSaving(false);
    }
  };

  // R√©cup√©rer la session utilisateur
  const { data: session } = useSession();
  const clientUserId = (session?.user as any)?.id || null;
  const [isFlowAnimate, setIsFlowAnimate] = useState(false);
  const [activeStep, setActiveStep] = useState<number | null>(null); // null, 0 (node), 0.5 (wire), 1 (node)...
  const [runningNodeId, setRunningNodeId] = useState<number | null>(null); // Node currently executing
  const [nodeStatuses, setNodeStatuses] = useState<
    Record<number, "success" | "error" | "warning" | "skipped" | "running">
  >({});
  const [connectingFrom, setConnectingFrom] = useState<number | null>(null); // Node ID we're connecting FROM
  const [mousePos, setMousePos] = useState({ x: 0, y: 0 }); // For drawing temp connection line
  const [isSaving, setIsSaving] = useState(false);
  const [isLaunching, setIsLaunching] = useState(false);
  const [launchError, setLaunchError] = useState<string | null>(null);
  const [launchSuccess, setLaunchSuccess] = useState(false);
  const [isAiInstructionsOpen, setIsAiInstructionsOpen] = useState(false);
  const [executionSequence, setExecutionSequence] = useState<any[]>([]);

  // Handle Escape key to cancel connecting
  useEffect(() => {
    const handleEscape = (e: KeyboardEvent) => {
      if (e.key === "Escape" && connectingFrom !== null) {
        setConnectingFrom(null);
        console.log("‚ùå Connection cancelled via ESC");
      }
    };

    window.addEventListener("keydown", handleEscape);
    return () => window.removeEventListener("keydown", handleEscape);
  }, [connectingFrom]);

  // Handle execution result from simulator
  const handleExecutionResult = (result: any) => {
    // Store rich execution data for n8n-style logs
    if (result.executedNodes) {
      const enrichedLogs = result.executedNodes.map((node: any, index: number) => ({
        ...node,
        stepNumber: index + 1,
        totalSteps: result.executedNodes.length,
        executionId: `exec_${Date.now()}`,
        input: { message: node.nodeName },
        output: { result: node.message, data: node.data || null }
      }));
      setExecutionLogs(enrichedLogs);
    } else if (result.logs) {
      setExecutionLogs(result.logs);
    }
    if (result.executedNodes) {
      setExecutionSequence(result.executedNodes);
      setIsFlowAnimate(true);

      const statuses: Record<
        number,
        "success" | "error" | "warning" | "skipped"
      > = {};
      result.executedNodes.forEach((node: any) => {
        statuses[node.nodeId] = node.status;
      });
      setNodeStatuses(statuses);

      // Clear statuses and sequence after a while
      setTimeout(() => {
        setNodeStatuses({});
        setExecutionSequence([]);
      }, 15000);
    }
  };

  // NOTE: Animation is now controlled directly by WhatsAppSimulator in real-time
  // This useEffect is disabled to avoid double-animation
  // The WhatsAppSimulator calls setActiveStep and setNodeStatuses during execution
  // useEffect(() => {
  //   if (!isFlowAnimate || executionSequence.length === 0) {
  //     setActiveStep(null);
  //     return;
  //   }

  //   let isMounted = true;

  //   const runExecutionAnimation = async () => {
  //     const statuses: Record<
  //       number,
  //       "success" | "error" | "warning" | "skipped" | "running"
  //     > = {};
  //     let currentIndex = 0;

  //     for (const execNode of executionSequence) {
  //       if (!isMounted) break;

  //       const nodeIdx = nodes.findIndex((n) => n.id === execNode.nodeId);
  //       if (nodeIdx === -1) {
  //         currentIndex++;
  //         continue;
  //       }

  //       // 1. FIRST: Set node as RUNNING (blue pulsing)
  //       console.log(`üîÑ Running node ${nodeIdx}: ${execNode.nodeName}`);
  //       setActiveStep(nodeIdx);
  //       setRunningNodeId(execNode.nodeId);
  //       statuses[execNode.nodeId] = "running";
  //       setNodeStatuses({ ...statuses });

  //       // Wait for execution duration (simulate processing)
  //       const processingTime = Math.min(execNode.duration || 500, 2000);
  //       await new Promise((resolve) => setTimeout(resolve, processingTime));

  //       // 2. THEN: Update to final status (success/error)
  //       console.log(`‚úì Completed node ${nodeIdx}: ${execNode.status}`);
  //       statuses[execNode.nodeId] = execNode.status;
  //       setNodeStatuses({ ...statuses });
  //       setRunningNodeId(null);

  //       // Brief pause to show the result
  //       await new Promise((resolve) => setTimeout(resolve, 400));

  //       // 3. ANIMATE WIRE to next node (if not last)
  //       if (currentIndex < executionSequence.length - 1) {
  //         console.log(`‚Üí Wire animation from ${nodeIdx} to next`);
  //         setActiveStep(nodeIdx + 0.5);
  //         await new Promise((resolve) => setTimeout(resolve, 600));
  //       }

  //       currentIndex++;
  //     }

  //     // Animation complete
  //     if (isMounted) {
  //       console.log("‚úÖ Execution animation completed");
  //       setActiveStep(null);
  //       setRunningNodeId(null);
        
  //       // Keep statuses visible for review
  //       setTimeout(() => {
  //         if (isMounted) {
  //           setNodeStatuses({});
  //           setIsFlowAnimate(false);
  //         }
  //       }, 5000);
  //     }
  //   };

  //   runExecutionAnimation();

  //   return () => {
  //     isMounted = false;
  //   };
  // }, [isFlowAnimate, executionSequence, nodes]);

  const [isProductModalOpen, setIsProductModalOpen] = useState(false);
  const [editingProduct, setEditingProduct] = useState<any>(null);
  const [newProduct, setNewProduct] = useState({
    name: "",
    description: "",
    price: "",
    stock: "",
    image: "üì¶",
    labels: "",
  });
  const [currency, setCurrency] = useState<"USD" | "EUR" | "XOF" | "CAD">(
    "USD",
  );
  const fileInputRef = useRef<HTMLInputElement>(null);

  const handleImageUpload = (e: React.ChangeEvent<HTMLInputElement>) => {
    const file = e.target.files?.[0];
    if (file) {
      const reader = new FileReader();
      reader.onloadend = () => {
        const img = new window.Image();
        img.onload = () => {
          const canvas = document.createElement("canvas");
          const MAX_WIDTH = 300; // Un aper√ßu n'a pas besoin de plus
          const MAX_HEIGHT = 300;
          let width = img.width;
          let height = img.height;

          if (width > height) {
            if (width > MAX_WIDTH) {
              height *= MAX_WIDTH / width;
              width = MAX_WIDTH;
            }
          } else {
            if (height > MAX_HEIGHT) {
              width *= MAX_HEIGHT / height;
              height = MAX_HEIGHT;
            }
          }

          canvas.width = width;
          canvas.height = height;
          const ctx = canvas.getContext("2d");
          ctx?.drawImage(img, 0, 0, width, height);

          // Compression en JPEG avec qualit√© 0.7 pour gagner √©norm√©ment d'espace
          const compressedBase64 = canvas.toDataURL("image/jpeg", 0.7);

          if (editingProduct) {
            setEditingProduct({ ...editingProduct, image: compressedBase64 });
          } else {
            setNewProduct({ ...newProduct, image: compressedBase64 });
          }
        };
        img.src = reader.result as string;
      };
      reader.readAsDataURL(file);
    }
  };

  useEffect(() => {
    if (!isLoaded.current) return;
    try {
      localStorage.setItem("draft_products", JSON.stringify(products));
      localStorage.setItem("draft_currency", currency);
    } catch (e) {
      console.warn(
        "Storage quota exceeded for products, image might be too large.",
        e,
      );
    }
  }, [products, currency]);

  useEffect(() => {
    const savedProducts = localStorage.getItem("draft_products");
    if (savedProducts) {
      try {
        setProducts(JSON.parse(savedProducts));
      } catch (e) {
        console.error("Failed to parse products", e);
      }
    }
    const savedCurrency = localStorage.getItem("draft_currency");
    if (savedCurrency) {
      setCurrency(savedCurrency as any);
    }
  }, []);
  // ID unique pour la connexion WhatsApp de cette automatisation sp√©cifique
  const automationWhatsAppId =
    clientUserId && automationId ? `${clientUserId}_${automationId}` : null;

  useEffect(() => {
    const checkConnection = async () => {
      try {
        const response = await fetch("http://localhost:8080/api/sessions");
        const data = await response.json();
        if (data.success) {
          // V√©rifier si une instance admin/simulateur est connect√©e
          const adminConnected = data.sessions.some(
            (s: any) =>
              s.status === "CONNECTED" &&
              (s.userId === "admin" || s.userId?.startsWith("auto_")),
          );
          setIsWhatsAppConnected(adminConnected);

          // V√©rifier si le client a connect√© son propre WhatsApp POUR CETTE AUTOMATISATION
          // On utilise un ID composite: clientUserId_automationId
          if (automationWhatsAppId) {
            const clientSession = data.sessions.find(
              (s: any) =>
                s.status === "CONNECTED" && s.userId === automationWhatsAppId,
            );
            setIsClientWhatsAppConnected(!!clientSession);
            if (clientSession?.jid) {
              setClientWhatsAppNumber(
                `+${clientSession.jid.split(":")[0].split("@")[0]}`,
              );
            } else {
              setClientWhatsAppNumber(null);
            }
          }
        }
      } catch (error) {
        console.error("Failed to fetch sessions for builder:", error);
      }
    };

    checkConnection();
    const interval = setInterval(checkConnection, 10000);
    return () => clearInterval(interval);
  }, [automationWhatsAppId]);

  const handleDisconnectWhatsApp = async () => {
    if (!automationWhatsAppId) return;
    setIsDisconnectingWhatsApp(true);
    try {
      const resp = await fetch("/api/whatsapp/disconnect", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ userId: automationWhatsAppId }),
      });

      const rawText = await resp.clone().text();
      let data: any = null;
      try {
        data = rawText ? JSON.parse(rawText) : null;
      } catch (e) {
        data = null;
      }

      if (!resp.ok) {
        console.warn("[Disconnect WhatsApp] API Error:", {
          status: resp.status,
          statusText: resp.statusText,
          body: rawText,
          parsed: data,
        });
        return;
      }

      // Update UI state immediately; the polling effect will confirm shortly.
      setIsClientWhatsAppConnected(false);
      setClientWhatsAppNumber(null);
    } catch (e) {
      console.warn("[Disconnect WhatsApp] Network Error:", e);
    } finally {
      setIsDisconnectingWhatsApp(false);
    }
  };

  const handleManualSave = async () => {
    setIsSaving(true);
    try {
      // Sauvegarde locale de secours
      localStorage.setItem("draft_workflow_name", workflowName);
      localStorage.setItem("draft_workflow_nodes", JSON.stringify(nodes));
      localStorage.setItem("draft_automation_id", automationId);
      localStorage.setItem("draft_currency", currency);

      // Pr√©paration du payload pour la base de donn√©es
      const triggerKeywords: string[] = [];
      let aiInstructions = "";

      nodes.forEach((node) => {
        try {
          const cfg = JSON.parse(node.config || "{}");
          if (cfg.keywords && Array.isArray(cfg.keywords)) {
            triggerKeywords.push(...cfg.keywords);
          }
          if (cfg.aiInstructions) {
            aiInstructions += cfg.aiInstructions + "\n";
          }
        } catch (e) {
          // Ignore
        }
      });

      const payload = {
        id: automationId,
        name: workflowName,
        nodes: nodes,
        template: selectedTemplate,
        products: products,
        currency: currency,
        triggerKeywords: triggerKeywords,
        aiInstructions: aiInstructions.trim() || null,
        whatsappNumber: clientWhatsAppNumber,
        telegramBotToken: tgBotToken || null,
        isActive: false, // Sauvegarde manuelle = Brouillon par d√©faut
      };

      const response = await fetch("/api/automations", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(payload),
      });

      if (!response.ok) {
        let details: any = null;
        try {
          details = await response.json();
        } catch (e) {
          try {
            details = await response.text();
          } catch (e2) {
            details = null;
          }
        }
        console.error("[Automation Save] API Error:", details);
        throw new Error(
          typeof details === "object" && details?.error
            ? details.error
            : "Erreur base de donn√©es",
        );
      }
    } catch (e) {
      console.warn("√âchec de la sauvegarde:", e);
    } finally {
      // Petit d√©lai pour l'effet visuel du loader
      setTimeout(() => setIsSaving(false), 500);
    }
  };

  // Fonction pour lancer/sauvegarder l'automatisation dans la base de donn√©es
  const handleLaunchAutomation = async () => {
    setIsLaunching(true);
    setLaunchError(null);
    setLaunchSuccess(false);

    try {
      // Extraire les mots-cl√©s d√©clencheurs des nodes
      const triggerKeywords: string[] = [];
      nodes.forEach((node) => {
        try {
          const cfg = JSON.parse(node.config || "{}");
          if (cfg.keywords && Array.isArray(cfg.keywords)) {
            triggerKeywords.push(...cfg.keywords);
          }
        } catch (e) {
          // Ignore parse errors
        }
      });

      // Extraire les instructions IA globales
      let aiInstructions = "";
      nodes.forEach((node) => {
        try {
          const cfg = JSON.parse(node.config || "{}");
          if (cfg.aiInstructions) {
            aiInstructions += cfg.aiInstructions + "\n";
          }
        } catch (e) {
          // Ignore parse errors
        }
      });

      const payload = {
        id: automationId,
        name: workflowName,
        description: `Automatisation ${workflowName} cr√©√©e le ${new Date().toLocaleDateString("fr-FR")}`,
        nodes: nodes,
        template: selectedTemplate,
        products: products,
        currency: currency,
        triggerKeywords: triggerKeywords,
        aiInstructions: aiInstructions.trim() || null,
        whatsappNumber: clientWhatsAppNumber,
        telegramBotToken: tgBotToken || null,
        isActive: true,
      };

      const response = await fetch("/api/automations", {
        method: "POST",
        headers: {
          "Content-Type": "application/json",
        },
        body: JSON.stringify(payload),
      });

      const data = await response.json();

      if (!response.ok) {
        throw new Error(data.error || "Erreur lors du lancement");
      }

      setLaunchSuccess(true);

      // Nettoyer le localStorage apr√®s sauvegarde r√©ussie
      localStorage.removeItem("draft_workflow_name");
      localStorage.removeItem("draft_workflow_nodes");
      localStorage.removeItem("draft_automation_id");
      localStorage.removeItem("draft_products");
      localStorage.removeItem("draft_currency");

      // Fermer le modal apr√®s 2 secondes
      setTimeout(() => {
        setShowPublishModal(false);
        setLaunchSuccess(false);
      }, 2000);
    } catch (error) {
      console.error("Error launching automation:", error);
      setLaunchError(
        error instanceof Error ? error.message : "Erreur inconnue",
      );
    } finally {
      setIsLaunching(false);
    }
  };

  const handleAddProduct = () => {
    const product = {
      ...newProduct,
      id: Date.now(),
      price: parseFloat(newProduct.price) || 0,
      stock: parseInt(newProduct.stock) || 0,
      labels: newProduct.labels
        .split(",")
        .map((l) => l.trim())
        .filter((l) => l !== ""),
    };
    setProducts((prev) => [...prev, product as Product]);
    setNewProduct({
      name: "",
      description: "",
      price: "",
      stock: "",
      image: "üì¶",
      labels: "",
    });
    setIsProductModalOpen(false);
  };

  const handleUpdateProduct = () => {
    if (!editingProduct) return;
    const updatedProducts = products.map((p) =>
      p.id === editingProduct.id
        ? {
          ...editingProduct,
          price: parseFloat(editingProduct.price) || 0,
          stock: parseInt(editingProduct.stock) || 0,
          labels:
            typeof editingProduct.labels === "string"
              ? editingProduct.labels
                .split(",")
                .map((l: string) => l.trim())
                .filter((l: string) => l !== "")
              : editingProduct.labels,
        }
        : p,
    );
    setProducts(updatedProducts);
    setEditingProduct(null);
    setIsProductModalOpen(false);
  };

  const handleDeleteProduct = (id: number) => {
    setProducts(products.filter((p) => p.id !== id));
  };

  // Complete connection when clicking on target node
  const handleNodeConnect = (targetNodeId: number) => {
    if (connectingFrom !== null && connectingFrom !== targetNodeId) {
      setNodes((prevNodes) =>
        prevNodes.map((n) =>
          n.id === connectingFrom ? { ...n, connectedTo: targetNodeId } : n,
        ),
      );
      setConnectingFrom(null);
    }
  };

  // Zoom controls
  const handleZoomIn = () => setZoom((prev) => Math.min(prev + 0.1, 2));
  const handleZoomOut = () => setZoom((prev) => Math.max(prev - 0.1, 0.25));
  const handleZoomReset = () => setZoom(0.8);
  const handleZoomFit = () => setZoom(0.5);

  const [lastMousePos, setLastMousePos] = useState({ x: 0, y: 0 });

  const handleCanvasMouseDown = (e: React.MouseEvent) => {
    if (e.button !== 0) return; // Only left click
    const canvas = e.currentTarget.getBoundingClientRect();
    const x = (e.clientX - canvas.left) / zoom;
    const y = (e.clientY - canvas.top) / zoom;

    setIsSelecting(true);
    setSelectionRect({ x1: x, y1: y, x2: x, y2: y });
    setLastMousePos({ x: e.clientX, y: e.clientY });

    // If clicking without Ctrl/Meta, immediately clear (visually responsive)
    if (!e.ctrlKey && !e.metaKey) {
      setSelectedNodeIds(new Set());
      setIsRightPanelOpen(false);
      setNodePickerPos(null);
    }
  };

  const handleCanvasMouseMove = (e: React.MouseEvent) => {
    const canvas = e.currentTarget.getBoundingClientRect();
    const x = (e.clientX - canvas.left) / zoom;
    const y = (e.clientY - canvas.top) / zoom;

    // Track mouse position for connection drawing
    if (connectingFrom !== null) {
      setMousePos({ x, y });
    }

    if (!isSelecting || !selectionRect) return;

    setSelectionRect((prev) => (prev ? { ...prev, x2: x, y2: y } : null));

    // Calculate overlap with nodes
    const xMin = Math.min(selectionRect.x1, x);
    const xMax = Math.max(selectionRect.x1, x);
    const yMin = Math.min(selectionRect.y1, y);
    const yMax = Math.max(selectionRect.y1, y);

    const newlySelected = new Set<number>(
      e.ctrlKey || e.metaKey ? selectedNodeIds : [],
    );
    nodes.forEach((node) => {
      // Node size is roughly 96x120 (including label)
      const nodeWidth = 96;
      const nodeHeight = 120;

      const intersects =
        node.x < xMax &&
        node.x + nodeWidth > xMin &&
        node.y < yMax &&
        node.y + nodeHeight > yMin;

      if (intersects) {
        newlySelected.add(node.id);
      } else if (!e.ctrlKey && !e.metaKey) {
        newlySelected.delete(node.id);
      }
    });

    setSelectedNodeIds(newlySelected);
  };

  const handleCanvasMouseUp = (e: React.MouseEvent) => {
    if (!isSelecting) return;

    const dragDistance = Math.sqrt(
      Math.pow(e.clientX - lastMousePos.x, 2) +
      Math.pow(e.clientY - lastMousePos.y, 2),
    );

    setIsSelecting(false);
    setSelectionRect(null);

    // Functional update to avoid stale state & definitively clear selection on click
    setSelectedNodeIds((current) => {
      if (dragDistance <= 5 && !e.ctrlKey && !e.metaKey) {
        // It was a simple click in the void - CLEAR EVERYTHING
        setIsRightPanelOpen(false);
        setNodePickerPos(null);
        return new Set();
      }
      if (current.size > 0 && dragDistance > 5) {
        setRightPanelTab("inspect");
        setIsRightPanelOpen(true);
      }
      return current;
    });
  };

  // Zoom controls... (duplicated but replacing previous zoom controls and clear selection)

  // Handle node selection (Ctrl/Cmd+Click for multi-select)
  const handleNodeSelect = (nodeId: number, event: React.MouseEvent) => {
    event.stopPropagation();
    const isMultiSelect = event.ctrlKey || event.metaKey;

    setSelectedNodeIds((prev) => {
      const newSet = new Set(prev);
      if (isMultiSelect) {
        // Toggle selection
        if (newSet.has(nodeId)) {
          newSet.delete(nodeId);
        } else {
          newSet.add(nodeId);
        }
      } else {
        // Single selection
        newSet.clear();
        newSet.add(nodeId);
      }
      return newSet;
    });
  };

  // Clear selection when clicking on canvas (now integrated into mouseDown)
  const handleCanvasClick = (e: React.MouseEvent) => {
    if (isSelecting) return;
    setSelectedNodeIds(new Set());
    setIsRightPanelOpen(false);
    setNodePickerPos(null);
    setConnectingFrom(null); // Cancel any pending connection
  };

  const hasTrigger = nodes.some((n) =>
    ["whatsapp_message", "keyword", "new_contact"].includes(n.type),
  );

  const insertNode = (
    index: number,
    nodeType: string,
    nodeName: string,
    x: number,
    y: number,
  ) => {
    const isTriggerType = [
      "whatsapp_message",
      "keyword",
      "new_contact",
    ].includes(nodeType);
    if (isTriggerType && hasTrigger) {
      alert("Un workflow ne peut avoir qu'un seul d√©clencheur.");
      return;
    }

    const newNode = {
      id: Date.now(),
      type: nodeType,
      name: nodeName,
      x,
      y,
      config: "{}",
    };
    const newNodes = [...nodes];
    newNodes.splice(index, 0, newNode);
    setNodes(newNodes);
    setNodePickerPos(null);
    setSelectedNodeIds(new Set([newNode.id]));
    setIsRightPanelOpen(true);
    setRightPanelTab("inspect");
  };

  // Handle node position change (for free-form dragging) - moves all selected nodes together
  const handlePositionChange = (
    id: number,
    deltaX: number,
    deltaY: number,
    isSelected: boolean,
  ) => {
    setNodes((prev) =>
      prev.map((node) => {
        // If this node is being dragged
        if (node.id === id) {
          return { ...node, x: node.x + deltaX, y: node.y + deltaY };
        }
        // If this node is also selected (group move)
        if (isSelected && selectedNodeIds.has(node.id)) {
          return { ...node, x: node.x + deltaX, y: node.y + deltaY };
        }
        return node;
      }),
    );
  };

  // Add a new node at a specific position
  const addNodeAtPosition = (
    nodeType: string,
    nodeName: string,
    x?: number,
    y?: number,
  ) => {
    const isTriggerType = [
      "whatsapp_message",
      "keyword",
      "new_contact",
    ].includes(nodeType);
    if (isTriggerType && hasTrigger) {
      alert("Un workflow ne peut avoir qu'un seul d√©clencheur.");
      return;
    }

    const lastNode = nodes[nodes.length - 1];
    const newX = x ?? (lastNode ? lastNode.x + 250 : 100);
    const newY = y ?? (lastNode ? lastNode.y : 100);

    // Default configs based on type - now using structured JSON
    let defaultConfig = "{}";

    if (nodeType === "whatsapp_message" || nodeType === "telegram_message") {
      defaultConfig = JSON.stringify({ aiInstructions: "" });
    } else if (nodeType === "gpt_analyze" || nodeType === "gpt_respond") {
      defaultConfig = JSON.stringify({
        model: "gpt-4o",
        system: "Tu es un assistant utile.",
        temperature: 0.7,
        aiInstructions: "",
      });
    } else if (nodeType === "send_text") {
      defaultConfig = JSON.stringify({
        text: "",
        aiInstructions: "",
      });
    } else if (nodeType === "show_catalog") {
      defaultConfig = JSON.stringify({
        category: "all",
        layout: "grid",
        selectedProducts: [],
        aiInstructions: "",
      });
    } else if (nodeType === "anti_ban") {
      defaultConfig = JSON.stringify({ min: 2, max: 10 });
    } else if (nodeType === "keyword") {
      defaultConfig = JSON.stringify({ keywords: "", aiInstructions: "" });
    } else if (nodeType === "delay") {
      defaultConfig = JSON.stringify({ delaySeconds: 5, aiInstructions: "" });
    } else if (nodeType === "chariow") {
      defaultConfig = JSON.stringify({
        action: "view",
        currency: "XOF",
        aiInstructions: "",
      });
    }

    const newNode = {
      id: Date.now(),
      type: nodeType,
      name: nodeName,
      config: defaultConfig,
      x: newX,
      y: newY,
    };

    setNodes([...nodes, newNode]);
    setSelectedNodeIds(new Set([newNode.id]));
    setIsRightPanelOpen(true);
    setRightPanelTab("inspect");
  };

  const handleSelectTemplate = (templateId: string) => {
    setSelectedTemplate(templateId);

    // Configuration scripts pour l'IA plateforme CONNECT
    const connectSupportPrompt = `Tu es l'assistant IA de CONNECT, la plateforme d'automatisation WhatsApp leader.
Tes missions :
1. Aider les entreprises √† configurer leurs workflows.
2. Expliquer comment connecter un compte WhatsApp.
3. Guider sur l'utilisation du CRM int√©gr√©.
R√©ponds de mani√®re professionnelle, concise et utilise des emojis pour rendre la conversation agr√©able.`;

    const connectSalesPrompt = `Tu es l'expert commercial de CONNECT.
Ton but est de transformer chaque message en vente.
1. Pr√©sente les avantages de CONNECT : gain de temps, 24/7, pas besoin de coder.
2. Si le client h√©site, propose de voir le catalogue.
3. Toujours finir par une question pour engager le client.`;

    // Configuration de workflows ULTRA-COMPLEXE (7-10 n≈ìuds par template)
    if (templateId === "ecommerce") {
      setNodes([
        {
          id: 1,
          type: "whatsapp_message",
          name: "Entr√©e Client",
          config: JSON.stringify({ aiInstructions: "Accueil chaleureux" }),
          x: 50,
          y: 300,
          connectedTo: 2,
        },
        {
          id: 2,
          type: "gpt_analyze",
          name: "Analyse Intention",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Trier: Achat, Support, Info.",
            aiInstructions: "",
          }),
          x: 250,
          y: 300,
          connectedTo: 3,
        },
        {
          id: 3,
          type: "gpt_respond",
          name: "Vendeur IA",
          config: JSON.stringify({
            model: "gpt-4o",
            system: connectSalesPrompt,
            aiInstructions: "G√®re les objections.",
          }),
          x: 450,
          y: 300,
          connectedTo: 4,
        },
        {
          id: 4,
          type: "chariow",
          name: "Panier Interactif",
          config: JSON.stringify({ action: "view" }),
          x: 650,
          y: 300,
          connectedTo: 5,
        },
        {
          id: 5,
          type: "clock",
          name: "Attente R√©flexion",
          config: JSON.stringify({ delay: "15m" }),
          x: 850,
          y: 300,
          connectedTo: 6,
        },
        {
          id: 6,
          type: "gpt_respond",
          name: "Relance Douce",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Propose un √©chantillon gratuit.",
            aiInstructions: "",
          }),
          x: 1050,
          y: 300,
          connectedTo: 7,
        },
        {
          id: 7,
          type: "chariow",
          name: "Paiement S√©curis√©",
          config: JSON.stringify({ action: "checkout" }),
          x: 1250,
          y: 300,
          connectedTo: 8,
        },
        {
          id: 8,
          type: "send_text",
          name: "Merci & Livraison",
          config: JSON.stringify({
            text: "Merci ! Votre commande est en route. üöö",
            aiInstructions: "",
          }),
          x: 1450,
          y: 300,
        },
      ]);
      setWorkflowName("Boutique Enterprise Full-Funnel");
    } else if (templateId === "support") {
      setNodes([
        {
          id: 1,
          type: "whatsapp_message",
          name: "Demande Support",
          config: JSON.stringify({ aiInstructions: "" }),
          x: 50,
          y: 300,
          connectedTo: 2,
        },
        {
          id: 2,
          type: "gpt_analyze",
          name: "Triage Technique",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Identifie le bug ou la question.",
            aiInstructions: "",
          }),
          x: 250,
          y: 300,
          connectedTo: 3,
        },
        {
          id: 3,
          type: "gpt_respond",
          name: "R√©ponse Auto N1",
          config: JSON.stringify({
            model: "gpt-4o",
            system: connectSupportPrompt,
            aiInstructions: "",
          }),
          x: 450,
          y: 300,
          connectedTo: 4,
        },
        {
          id: 4,
          type: "clock",
          name: "Pause V√©rification",
          config: JSON.stringify({ delay: "5m" }),
          x: 650,
          y: 300,
          connectedTo: 5,
        },
        {
          id: 5,
          type: "gpt_analyze",
          name: "Satisfaction Test",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Le client est-il OK ?",
            aiInstructions: "",
          }),
          x: 850,
          y: 300,
          connectedTo: 6,
        },
        {
          id: 6,
          type: "whatsapp_message",
          name: "Escalade Expert",
          config: JSON.stringify({
            aiInstructions: "Si pas OK, passe √† l'humain.",
          }),
          x: 1050,
          y: 300,
          connectedTo: 7,
        },
        {
          id: 7,
          type: "send_text",
          name: "Archivage Ticket",
          config: JSON.stringify({
            text: "Ticket #1234 clos.",
            aiInstructions: "",
          }),
          x: 1250,
          y: 300,
        },
      ]);
      setWorkflowName("Support Client Multiniveau IA");
    } else if (templateId === "appointment") {
      setNodes([
        {
          id: 1,
          type: "whatsapp_message",
          name: "Demande Booking",
          config: JSON.stringify({ aiInstructions: "" }),
          x: 50,
          y: 300,
          connectedTo: 2,
        },
        {
          id: 2,
          type: "gpt_analyze",
          name: "Extract Horaires",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Extrait date/heure.",
            aiInstructions: "",
          }),
          x: 250,
          y: 300,
          connectedTo: 3,
        },
        {
          id: 3,
          type: "calendar",
          name: "V√©rif Disponibilit√©",
          config: JSON.stringify({ calendarId: "primary" }),
          x: 450,
          y: 300,
          connectedTo: 4,
        },
        {
          id: 4,
          type: "gpt_respond",
          name: "N√©gociateur IA",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Si occup√©, propose demain.",
            aiInstructions: "",
          }),
          x: 650,
          y: 300,
          connectedTo: 5,
        },
        {
          id: 5,
          type: "calendar",
          name: "Booking Final",
          config: JSON.stringify({ calendarId: "primary" }),
          x: 850,
          y: 300,
          connectedTo: 6,
        },
        {
          id: 6,
          type: "clock",
          name: "Rappel J-1",
          config: JSON.stringify({ delay: "24h" }),
          x: 1050,
          y: 300,
          connectedTo: 7,
        },
        {
          id: 7,
          type: "send_text",
          name: "Confirmation WhatsApp",
          config: JSON.stringify({
            text: "RDV confirm√© ! ‚úÖ",
            aiInstructions: "",
          }),
          x: 1250,
          y: 300,
        },
      ]);
      setWorkflowName("Syst√®me de Booking Intelligent");
    } else if (templateId === "lead") {
      setNodes([
        {
          id: 1,
          type: "whatsapp_message",
          name: "Input Lead",
          config: JSON.stringify({ aiInstructions: "" }),
          x: 50,
          y: 300,
          connectedTo: 2,
        },
        {
          id: 2,
          type: "gpt_analyze",
          name: "Qualification N1",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Demande le budget.",
            aiInstructions: "",
          }),
          x: 250,
          y: 300,
          connectedTo: 3,
        },
        {
          id: 3,
          type: "gpt_analyze",
          name: "Qualification N2",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Demande le besoin.",
            aiInstructions: "",
          }),
          x: 450,
          y: 300,
          connectedTo: 4,
        },
        {
          id: 4,
          type: "gpt_analyze",
          name: "Lead Scoring",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Score de 1 √† 10.",
            aiInstructions: "",
          }),
          x: 650,
          y: 300,
          connectedTo: 5,
        },
        {
          id: 5,
          type: "gpt_respond",
          name: "Filtre Enterprise",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Si Score > 7, transfert direct.",
            aiInstructions: "",
          }),
          x: 850,
          y: 300,
          connectedTo: 6,
        },
        {
          id: 6,
          type: "send_text",
          name: "Lien Calendly",
          config: JSON.stringify({
            text: "R√©servez votre d√©mo ici...",
            aiInstructions: "",
          }),
          x: 1050,
          y: 300,
        },
      ]);
      setWorkflowName("Qualification & Scoring Prospect Auto");
    } else if (templateId === "marketing") {
      setNodes([
        {
          id: 1,
          type: "keyword",
          name: "Mot-cl√© OFFRE",
          config: JSON.stringify({ keywords: "OFFRE", aiInstructions: "" }),
          x: 50,
          y: 300,
          connectedTo: 2,
        },
        {
          id: 2,
          type: "gpt_respond",
          name: "Accroche Sales",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Cr√©e l'urgence.",
            aiInstructions: "",
          }),
          x: 250,
          y: 300,
          connectedTo: 3,
        },
        {
          id: 3,
          type: "send_image",
          name: "Visuel Promo",
          config: JSON.stringify({ url: "", caption: "Regardez !" }),
          x: 450,
          y: 300,
          connectedTo: 4,
        },
        {
          id: 4,
          type: "clock",
          name: "Relance H+2",
          config: JSON.stringify({ delay: "2h" }),
          x: 650,
          y: 300,
          connectedTo: 5,
        },
        {
          id: 5,
          type: "gpt_respond",
          name: "Message Rappel",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Derni√®re chance avant fin.",
            aiInstructions: "",
          }),
          x: 850,
          y: 300,
          connectedTo: 6,
        },
        {
          id: 6,
          type: "send_text",
          name: "Lien Checkout",
          config: JSON.stringify({
            text: "Profitez-en maintenant !",
            aiInstructions: "",
          }),
          x: 1050,
          y: 300,
        },
      ]);
      setWorkflowName("Tunnel de Vente Marketing Viral");
    } else if (templateId === "survey") {
      setNodes([
        {
          id: 1,
          type: "trigger",
          name: "Post-Achat",
          config: JSON.stringify({ event: "delivered" }),
          x: 50,
          y: 300,
          connectedTo: 2,
        },
        {
          id: 2,
          type: "send_text",
          name: "Question NPS",
          config: JSON.stringify({
            text: "Notez-nous de 0 √† 10.",
            aiInstructions: "",
          }),
          x: 250,
          y: 300,
          connectedTo: 3,
        },
        {
          id: 3,
          type: "gpt_analyze",
          name: "Analyse Sentiment",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Analyse le ton de la r√©ponse.",
            aiInstructions: "",
          }),
          x: 450,
          y: 300,
          connectedTo: 4,
        },
        {
          id: 4,
          type: "gpt_respond",
          name: "R√©ponse Adapt√©e",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Remercie ou excuse-toi.",
            aiInstructions: "",
          }),
          x: 650,
          y: 300,
          connectedTo: 5,
        },
        {
          id: 5,
          type: "gpt_analyze",
          name: "Tag Client VIP",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Si Note > 9, marque comme Ambassadeur.",
            aiInstructions: "",
          }),
          x: 850,
          y: 300,
        },
      ]);
      setWorkflowName("Gestion d'Avis & Fid√©lisation");
    } else if (templateId === "abandon_cart") {
      setNodes([
        {
          id: 1,
          type: "trigger",
          name: "Abandon Panier",
          config: JSON.stringify({ event: "abandoned" }),
          x: 50,
          y: 300,
          connectedTo: 2,
        },
        {
          id: 2,
          type: "clock",
          name: "Attente 30m",
          config: JSON.stringify({ delay: "30m" }),
          x: 250,
          y: 300,
          connectedTo: 3,
        },
        {
          id: 3,
          type: "gpt_respond",
          name: "Relance 1",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Est-ce un probl√®me technique ?",
            aiInstructions: "",
          }),
          x: 450,
          y: 300,
          connectedTo: 4,
        },
        {
          id: 4,
          type: "clock",
          name: "Attente 24h",
          config: JSON.stringify({ delay: "24h" }),
          x: 650,
          y: 300,
          connectedTo: 5,
        },
        {
          id: 5,
          type: "gpt_respond",
          name: "Relance 2 + Coupon",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Voici -10% pour finir.",
            aiInstructions: "",
          }),
          x: 850,
          y: 300,
          connectedTo: 6,
        },
        {
          id: 6,
          type: "chariow",
          name: "Checkout Direct",
          config: JSON.stringify({ action: "checkout" }),
          x: 1050,
          y: 300,
        },
      ]);
      setWorkflowName("Machine de R√©cup√©ration de Paniers");
    } else if (templateId === "tracking") {
      setNodes([
        {
          id: 1,
          type: "whatsapp_message",
          name: "Mot-cl√© SUIVI",
          config: JSON.stringify({ keywords: "suivi", aiInstructions: "" }),
          x: 50,
          y: 300,
          connectedTo: 2,
        },
        {
          id: 2,
          type: "gpt_analyze",
          name: "Extract OrderID",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Num√©ro de commande ?",
            aiInstructions: "",
          }),
          x: 250,
          y: 300,
          connectedTo: 3,
        },
        {
          id: 3,
          type: "gpt_respond",
          name: "Check Status IA",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Simule la DB.",
            aiInstructions: "",
          }),
          x: 450,
          y: 300,
          connectedTo: 4,
        },
        {
          id: 4,
          type: "send_text",
          name: "Status Livraison",
          config: JSON.stringify({ text: "En cours...", aiInstructions: "" }),
          x: 650,
          y: 300,
          connectedTo: 5,
        },
        {
          id: 5,
          type: "clock",
          name: "Notification Demain",
          config: JSON.stringify({ delay: "24h" }),
          x: 850,
          y: 300,
          connectedTo: 6,
        },
        {
          id: 6,
          type: "send_text",
          name: "Alerte Proximit√©",
          config: JSON.stringify({
            text: "Le livreur arrive !",
            aiInstructions: "",
          }),
          x: 1050,
          y: 300,
        },
      ]);
      setWorkflowName("Logistique & Tracking Auto");
    } else if (templateId === "vip") {
      setNodes([
        {
          id: 1,
          type: "keyword",
          name: "JOIN VIP",
          config: JSON.stringify({ keywords: "VIP", aiInstructions: "" }),
          x: 50,
          y: 300,
          connectedTo: 2,
        },
        {
          id: 2,
          type: "gpt_analyze",
          name: "Check Total Spend",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "> 500‚Ç¨ ?",
            aiInstructions: "",
          }),
          x: 250,
          y: 300,
          connectedTo: 3,
        },
        {
          id: 3,
          type: "gpt_respond",
          name: "Bienvenue Club",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Message de prestige.",
            aiInstructions: "",
          }),
          x: 450,
          y: 300,
          connectedTo: 4,
        },
        {
          id: 4,
          type: "clock",
          name: "Attente 7j",
          config: JSON.stringify({ delay: "7d" }),
          x: 650,
          y: 300,
          connectedTo: 5,
        },
        {
          id: 5,
          type: "send_text",
          name: "Offre Membre",
          config: JSON.stringify({
            text: "Cadeau de la semaine...",
            aiInstructions: "",
          }),
          x: 850,
          y: 300,
        },
      ]);
      setWorkflowName("Club Fid√©lit√© Haut de Gamme");
    } else if (templateId === "quote") {
      setNodes([
        {
          id: 1,
          type: "whatsapp_message",
          name: "Demande DEVIS",
          config: JSON.stringify({ aiInstructions: "" }),
          x: 50,
          y: 300,
          connectedTo: 2,
        },
        {
          id: 2,
          type: "gpt_analyze",
          name: "Audit Expert IA",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Analyse les specs.",
            aiInstructions: "",
          }),
          x: 250,
          y: 300,
          connectedTo: 3,
        },
        {
          id: 3,
          type: "gpt_respond",
          name: "Proposition PDF",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "G√©n√®re les co√ªts.",
            aiInstructions: "",
          }),
          x: 450,
          y: 300,
          connectedTo: 4,
        },
        {
          id: 4,
          type: "send_text",
          name: "Validation Prix",
          config: JSON.stringify({
            text: "Acceptez-vous ?",
            aiInstructions: "",
          }),
          x: 650,
          y: 300,
          connectedTo: 5,
        },
        {
          id: 5,
          type: "whatsapp_message",
          name: "Alerte Patron",
          config: JSON.stringify({ aiInstructions: "Si valid√©, notifie." }),
          x: 850,
          y: 300,
        },
      ]);
      setWorkflowName("G√©n√©rateur de Devis Dynamique");
    } else if (templateId === "enterprise") {
      setNodes([
        {
          id: 1,
          type: "whatsapp_message",
          name: "Input Multicanal",
          config: JSON.stringify({ aiInstructions: "G√®re WHatApp/Telegram." }),
          x: 50,
          y: 300,
          connectedTo: 2,
        },
        {
          id: 2,
          type: "gpt_analyze",
          name: "Routage Intelligent",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "D√©termine l'expert (Vente, Tech, RH).",
            aiInstructions: "",
          }),
          x: 250,
          y: 300,
          connectedTo: 3,
        },
        {
          id: 3,
          type: "gpt_respond",
          name: "Expert IA Vente",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Vends le produit.",
            aiInstructions: "",
          }),
          x: 450,
          y: 300,
          connectedTo: 4,
        },
        {
          id: 4,
          type: "chariow",
          name: "Checkout Flow",
          config: JSON.stringify({ action: "checkout" }),
          x: 650,
          y: 300,
          connectedTo: 5,
        },
        {
          id: 5,
          type: "clock",
          name: "Support Post-Achat",
          config: JSON.stringify({ delay: "24h" }),
          x: 850,
          y: 300,
          connectedTo: 6,
        },
        {
          id: 6,
          type: "gpt_respond",
          name: "Check de Confort",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Tout fonctionne ?",
            aiInstructions: "",
          }),
          x: 1050,
          y: 300,
          connectedTo: 7,
        },
        {
          id: 7,
          type: "send_text",
          name: "Feedback Hub",
          config: JSON.stringify({
            text: "Merci de votre avis.",
            aiInstructions: "",
          }),
          x: 1250,
          y: 300,
        },
      ]);
      setWorkflowName("Automate Enterprise 360¬∞");
    } else if (templateId === "agency") {
      setNodes([
        {
          id: 1,
          type: "keyword",
          name: "Trigger BRIEF",
          config: JSON.stringify({ keywords: "BRIEF", aiInstructions: "" }),
          x: 50,
          y: 300,
          connectedTo: 2,
        },
        {
          id: 2,
          type: "gpt_analyze",
          name: "Consultant Strat√©gique",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Analyse le projet client.",
            aiInstructions: "",
          }),
          x: 250,
          y: 300,
          connectedTo: 3,
        },
        {
          id: 3,
          type: "gpt_respond",
          name: "G√©n√©rateur de Roadmap",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Cr√©e les √©tapes.",
            aiInstructions: "",
          }),
          x: 450,
          y: 300,
          connectedTo: 4,
        },
        {
          id: 4,
          type: "send_text",
          name: "Envoi Proposition",
          config: JSON.stringify({
            text: "Voici votre plan d'action...",
            aiInstructions: "",
          }),
          x: 650,
          y: 300,
          connectedTo: 5,
        },
        {
          id: 5,
          type: "calendar",
          name: "Kick-off Call",
          config: JSON.stringify({ calendarId: "sales" }),
          x: 850,
          y: 300,
        },
      ]);
      setWorkflowName("Pipeline Agence Digital Auto");
    } else if (templateId === "hr_pro" || templateId === "hr") {
      setNodes([
        {
          id: 1,
          type: "keyword",
          name: "Application JOB",
          config: JSON.stringify({ keywords: "JOB", aiInstructions: "" }),
          x: 50,
          y: 300,
          connectedTo: 2,
        },
        {
          id: 2,
          type: "gpt_analyze",
          name: "Screener IA",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "V√©rifie les dipl√¥mes.",
            aiInstructions: "",
          }),
          x: 250,
          y: 300,
          connectedTo: 3,
        },
        {
          id: 3,
          type: "gpt_respond",
          name: "Entretien Soft Skills",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Pose des questions de psycho.",
            aiInstructions: "",
          }),
          x: 450,
          y: 300,
          connectedTo: 4,
        },
        {
          id: 4,
          type: "gpt_analyze",
          name: "Rating Culturel",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Score de fit.",
            aiInstructions: "",
          }),
          x: 650,
          y: 300,
          connectedTo: 5,
        },
        {
          id: 5,
          type: "calendar",
          name: "Final Interview",
          config: JSON.stringify({ calendarId: "hr" }),
          x: 850,
          y: 300,
          connectedTo: 6,
        },
        {
          id: 6,
          type: "send_text",
          name: "Update Candidat",
          config: JSON.stringify({
            text: "Candidature en cours...",
            aiInstructions: "",
          }),
          x: 1050,
          y: 300,
        },
      ]);
      setWorkflowName("HR Master Pipeline");
    } else if (templateId === "contest") {
      setNodes([
        {
          id: 1,
          type: "keyword",
          name: "JEU2024",
          config: JSON.stringify({ keywords: "JEU", aiInstructions: "" }),
          x: 50,
          y: 300,
          connectedTo: 2,
        },
        {
          id: 2,
          type: "gpt_analyze",
          name: "Check Partage",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "V√©rifie si le client a partag√© √† 3 amis.",
            aiInstructions: "",
          }),
          x: 250,
          y: 300,
          connectedTo: 3,
        },
        {
          id: 3,
          type: "gpt_respond",
          name: "Status Inscription",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Confirme ou demande de partager plus.",
            aiInstructions: "",
          }),
          x: 450,
          y: 300,
          connectedTo: 4,
        },
        {
          id: 4,
          type: "clock",
          name: "End Date",
          config: JSON.stringify({ delay: "48h" }),
          x: 650,
          y: 300,
          connectedTo: 5,
        },
        {
          id: 5,
          type: "send_text",
          name: "Annonce R√©sultat",
          config: JSON.stringify({
            text: "Le gagnant est...",
            aiInstructions: "",
          }),
          x: 850,
          y: 300,
        },
      ]);
      setWorkflowName("Concours Viral & Social");
    } else if (templateId === "education") {
      setNodes([
        {
          id: 1,
          type: "keyword",
          name: "Inscription Cours",
          config: JSON.stringify({ keywords: "COURS", aiInstructions: "" }),
          x: 50,
          y: 300,
          connectedTo: 2,
        },
        {
          id: 2,
          type: "send_text",
          name: "Module 1",
          config: JSON.stringify({
            text: "Bienvenue ! Voici la premi√®re vid√©o...",
            aiInstructions: "",
          }),
          x: 250,
          y: 300,
          connectedTo: 3,
        },
        {
          id: 3,
          type: "clock",
          name: "Cooldown",
          config: JSON.stringify({ delay: "24h" }),
          x: 450,
          y: 300,
          connectedTo: 4,
        },
        {
          id: 4,
          type: "gpt_respond",
          name: "Quiz Module 1",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Pose une question sur le module 1.",
            aiInstructions: "",
          }),
          x: 650,
          y: 300,
          connectedTo: 5,
        },
        {
          id: 5,
          type: "gpt_analyze",
          name: "Check R√©ponse",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Valide si la r√©ponse est correcte.",
            aiInstructions: "",
          }),
          x: 850,
          y: 300,
        },
      ]);
      setWorkflowName("LMS WhatsApp Interactif");
    } else if (templateId === "restaurant") {
      setNodes([
        {
          id: 1,
          type: "whatsapp_message",
          name: "Affam√© ?",
          config: JSON.stringify({ aiInstructions: "" }),
          x: 50,
          y: 300,
          connectedTo: 2,
        },
        {
          id: 2,
          type: "gpt_analyze",
          name: "Choix Service",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Livraison ou R√©servation ?",
            aiInstructions: "",
          }),
          x: 250,
          y: 300,
          connectedTo: 3,
        },
        {
          id: 3,
          type: "gpt_respond",
          name: "Prise de Commande",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Demande les plats et restrictions alimentaires.",
            aiInstructions: "",
          }),
          x: 450,
          y: 300,
          connectedTo: 4,
        },
        {
          id: 4,
          type: "chariow",
          name: "Panier Repas",
          config: JSON.stringify({ action: "checkout" }),
          x: 650,
          y: 300,
          connectedTo: 5,
        },
        {
          id: 5,
          type: "send_text",
          name: "Confirmation Cuisine",
          config: JSON.stringify({
            text: "C'est en pr√©paration ! üë®‚Äçüç≥",
            aiInstructions: "",
          }),
          x: 850,
          y: 300,
        },
      ]);
      setWorkflowName("Restaurant & Click & Collect");
    } else if (templateId === "stock") {
      setNodes([
        {
          id: 1,
          type: "trigger",
          name: "Out of Stock Event",
          config: JSON.stringify({ event: "out_of_stock" }),
          x: 50,
          y: 300,
          connectedTo: 2,
        },
        {
          id: 2,
          type: "gpt_respond",
          name: "Waitlist Invitation",
          config: JSON.stringify({
            model: "gpt-4o",
            system: "Propose de s'inscrire pour l'alerte.",
            aiInstructions: "",
          }),
          x: 250,
          y: 300,
          connectedTo: 3,
        },
        {
          id: 3,
          type: "clock",
          name: "Wait for Restock",
          config: JSON.stringify({ delay: "0" }),
          x: 450,
          y: 300,
          connectedTo: 4,
        },
        {
          id: 4,
          type: "send_text",
          name: "Alerte Prioritaire",
          config: JSON.stringify({
            text: "Il en reste 5 ! D√©p√™chez-vous.",
            aiInstructions: "",
          }),
          x: 650,
          y: 300,
          connectedTo: 5,
        },
        {
          id: 5,
          type: "chariow",
          name: "Achat Rapide",
          config: JSON.stringify({ action: "checkout" }),
          x: 850,
          y: 300,
        },
      ]);
      setWorkflowName("Gestion de P√©nurie & Waitlist");
    } else {
      setNodes([
        {
          id: 1,
          type: "whatsapp_message",
          name: "Point d'Entr√©e",
          config: JSON.stringify({ aiInstructions: "" }),
          x: 50,
          y: 300,
        },
      ]);
      setWorkflowName("Nouveau Workflow");
    }

    setViewMode("builder");
  };

  const handleAIGenerate = () => {
    if (!aiPrompt.trim()) return;

    // Simuler la g√©n√©ration IA avec des positions
    setNodes([
      {
        id: 1,
        type: "whatsapp_message",
        name: "D√©clencheur",
        config: JSON.stringify({ aiInstructions: `Contexte: ${aiPrompt}` }),
        x: 100,
        y: 300,
        connectedTo: 2,
      },
      {
        id: 2,
        type: "gpt_analyze",
        name: "Analyse IA",
        config: JSON.stringify({
          model: "gpt-4o",
          system: `Analyse la demande suivante: ${aiPrompt}`,
          aiInstructions: "Sois perspicace.",
        }),
        x: 300,
        y: 300,
        connectedTo: 3,
      },
      {
        id: 3,
        type: "gpt_respond",
        name: "Action",
        config: JSON.stringify({
          model: "gpt-4o",
          system: `R√©ponds √† la situation: ${aiPrompt}`,
          aiInstructions: "Ton amical et pro.",
        }),
        x: 500,
        y: 300,
      },
    ]);
    setWorkflowName("Workflow IA - " + aiPrompt.slice(0, 20) + "...");
    setViewMode("builder");
  };

  const getNodeInfo = (nodeType: string) => {
    for (const category of nodeCategories) {
      const node = category.nodes.find((n) => n.id === nodeType);
      if (node) return { ...node, category };
    }
    return null;
  };

  return (
    <div className="flex min-h-screen bg-background text-foreground selection:bg-primary selection:text-black">
      <DashboardSidebar />

      <main className="flex-1 flex flex-col min-w-0 h-screen overflow-hidden">
        <DashboardHeader />

        {/* Mode: Templates Selection */}
        <AnimatePresence mode="wait">
          {viewMode === "templates" && (
            <motion.div
              key="templates"
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              className="flex-1 overflow-y-auto p-8"
            >
              <div className="max-w-5xl mx-auto">
                {/* Header */}
                <div className="text-center mb-10">
                  <h1 className="text-3xl font-black text-white mb-3">
                    Cr√©ez votre Automatisation WhatsApp
                  </h1>
                  <p className="text-muted-foreground text-sm max-w-xl mx-auto">
                    Choisissez un template pour d√©marrer rapidement ou d√©crivez
                    ce que vous voulez √† notre IA
                  </p>
                </div>

                {/* AI Assistant Card */}
                <Card className="border-primary/30 bg-primary/5 mb-8 overflow-hidden">
                  <CardContent className="p-6">
                    <div className="flex items-start gap-4">
                      <div className="h-12 w-12 rounded-2xl bg-primary/20 flex items-center justify-center shrink-0">
                        <Wand2 className="h-6 w-6 text-primary" />
                      </div>
                      <div className="flex-1">
                        <h3 className="text-lg font-bold text-white mb-1 flex items-center gap-2">
                          Assistant IA{" "}
                          <Badge className="bg-primary text-black text-[9px]">
                            Nouveau
                          </Badge>
                        </h3>
                        <p className="text-sm text-muted-foreground mb-4">
                          D√©crivez simplement ce que vous voulez automatiser et
                          notre IA cr√©era le workflow pour vous
                        </p>
                        <div className="flex gap-2">
                          <Input
                            value={aiPrompt}
                            onChange={(e) => setAiPrompt(e.target.value)}
                            placeholder="Ex: Je veux un bot qui r√©pond aux questions sur mes produits et prend les commandes..."
                            className="flex-1 bg-black/20 border-white/10 text-sm"
                          />
                          <Button
                            onClick={handleAIGenerate}
                            className="bg-primary text-black font-bold gap-2"
                          >
                            <Sparkles className="h-4 w-4" /> G√©n√©rer
                          </Button>
                        </div>
                      </div>
                    </div>
                  </CardContent>
                </Card>

                {/* User Creations Section - Premium Design */}
                {userAutomations.length > 0 && (
                  <div className="mb-10">
                    <h2 className="text-sm font-bold text-primary uppercase tracking-widest mb-6 flex items-center gap-2 italic">
                      <Zap className="h-4 w-4" /> Mes cr√©ations
                    </h2>
                    <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-5">
                      {userAutomations.map((automation) => (
                        <motion.div
                          key={automation.id}
                          whileHover={{ scale: 1.02, y: -4 }}
                          whileTap={{ scale: 0.98 }}
                          initial={{ opacity: 0, y: 20 }}
                          animate={{ opacity: 1, y: 0 }}
                          transition={{ duration: 0.3 }}
                        >
                          <div
                            className="relative cursor-pointer group"
                            onClick={() =>
                              handleLoadUserAutomation(automation.id)
                            }
                          >
                            {/* Card Background with Gradient */}
                            <div className="absolute inset-0 bg-gradient-to-br from-primary/20 via-primary/5 to-transparent rounded-2xl opacity-0 group-hover:opacity-100 transition-opacity duration-500" />

                            <div className="relative bg-[#1a1a1a] border border-white/10 rounded-2xl p-6 hover:border-primary/40 transition-all duration-300 overflow-hidden">
                              {/* Glow Effect */}
                              <div className="absolute top-0 right-0 w-32 h-32 bg-primary/10 rounded-full blur-3xl opacity-0 group-hover:opacity-50 transition-opacity duration-500 -translate-y-1/2 translate-x-1/2" />

                              {/* Header */}
                              <div className="flex items-start justify-between mb-4">
                                <div className="h-12 w-12 rounded-2xl bg-gradient-to-br from-primary/20 to-primary/5 border border-primary/20 flex items-center justify-center group-hover:scale-110 transition-transform duration-300">
                                  <Zap className="h-5 w-5 text-primary" />
                                </div>

                                {/* Status Badge */}
                                <div
                                  className={`flex items-center gap-1.5 px-3 py-1.5 rounded-full text-[9px] font-black uppercase tracking-widest ${automation.status === "ACTIVE"
                                    ? "bg-emerald-500/10 text-emerald-400 border border-emerald-500/20"
                                    : "bg-amber-500/10 text-amber-400 border border-amber-500/20"
                                    }`}
                                >
                                  <div
                                    className={`h-1.5 w-1.5 rounded-full ${automation.status === "ACTIVE"
                                      ? "bg-emerald-500 animate-pulse"
                                      : "bg-amber-500"
                                      }`}
                                  />
                                  {automation.status === "ACTIVE"
                                    ? "Actif"
                                    : "Brouillon"}
                                </div>
                              </div>

                              {/* Content */}
                              <div className="space-y-2 mb-4">
                                <h3 className="text-white font-black text-lg truncate group-hover:text-primary transition-colors italic tracking-tighter uppercase">
                                  {automation.name || "Sans titre"}
                                </h3>
                                <p className="text-muted-foreground/60 text-[11px] line-clamp-2 font-medium uppercase tracking-wider">
                                  {automation.description ||
                                    "Automatisation cr√©√©e pour votre business"}
                                </p>
                              </div>

                              {/* Stats / Metadata */}
                              <div className="flex items-center gap-4 mb-4">
                                <div className="flex items-center gap-1.5">
                                  <Activity className="h-3 w-3 text-muted-foreground/50" />
                                  <span className="text-[10px] text-muted-foreground/70 font-bold uppercase tracking-widest">
                                    {automation.triggerCount || 0} d√©clencheurs
                                  </span>
                                </div>
                                {automation.whatsappNumber && (
                                  <div className="flex items-center gap-1.5">
                                    <Smartphone className="h-3 w-3 text-emerald-500/50" />
                                    <span className="text-[10px] text-muted-foreground/70 font-bold uppercase tracking-widest">
                                      Connect√©
                                    </span>
                                  </div>
                                )}
                              </div>

                              {/* Footer */}
                              <div className="flex items-center justify-between pt-4 border-t border-white/5">
                                <div className="flex items-center gap-2">
                                  <Clock className="h-3 w-3 text-muted-foreground/40" />
                                  <span className="text-[10px] text-muted-foreground/50 font-bold uppercase tracking-widest">
                                    {new Date(
                                      automation.updatedAt,
                                    ).toLocaleDateString("fr-FR", {
                                      day: "2-digit",
                                      month: "short",
                                      year: "numeric",
                                    })}
                                  </span>
                                </div>
                                <div className="flex items-center gap-1 text-primary opacity-0 group-hover:opacity-100 transition-all duration-300 translate-x-2 group-hover:translate-x-0">
                                  <span className="text-[10px] font-black uppercase tracking-widest">
                                    Ouvrir
                                  </span>
                                  <ChevronRight className="h-4 w-4" />
                                </div>
                              </div>
                            </div>
                          </div>
                        </motion.div>
                      ))}
                    </div>
                  </div>
                )}

                {/* Templates Grid */}
                <div className="mb-6">
                  <h2 className="text-sm font-bold text-muted-foreground uppercase tracking-widest mb-4">
                    Ou choisissez un template
                  </h2>
                  <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                    {workflowTemplates.map((template) => (
                      <motion.div
                        key={template.id}
                        whileHover={{ scale: 1.02, y: -2 }}
                        whileTap={{ scale: 0.98 }}
                      >
                        <Card
                          className="border-white/10 bg-card hover:border-primary/30 cursor-pointer transition-all h-full relative overflow-hidden group"
                          onClick={() => handleSelectTemplate(template.id)}
                        >
                          {template.popular && (
                            <div className="absolute top-3 right-3">
                              <Badge className="bg-orange-500/20 text-orange-400 text-[9px]">
                                <Star className="h-2.5 w-2.5 mr-1 fill-current" />{" "}
                                Populaire
                              </Badge>
                            </div>
                          )}
                          <CardContent className="p-5">
                            <div
                              className={`h-12 w-12 rounded-2xl ${template.bg} flex items-center justify-center mb-4`}
                            >
                              <template.icon
                                className={`h-6 w-6 ${template.color}`}
                              />
                            </div>
                            <h3 className="text-white font-bold mb-1">
                              {template.name}
                            </h3>
                            <p className="text-muted-foreground text-xs mb-4 line-clamp-2">
                              {template.description}
                            </p>
                            <div className="flex flex-wrap gap-1">
                              {template.features
                                .slice(0, 3)
                                .map((feature, idx) => (
                                  <span
                                    key={idx}
                                    className="text-[9px] px-2 py-0.5 rounded-full bg-white/5 text-muted-foreground"
                                  >
                                    {feature}
                                  </span>
                                ))}
                            </div>
                            <div className="absolute bottom-4 right-4 opacity-0 group-hover:opacity-100 transition-opacity">
                              <ChevronRight className="h-5 w-5 text-primary" />
                            </div>
                          </CardContent>
                        </Card>
                      </motion.div>
                    ))}
                  </div>
                </div>
              </div>
            </motion.div>
          )}

          {/* Mode: Workflow Builder */}
          {viewMode === "builder" && (
            <motion.div
              key="builder"
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              className="flex-1 flex flex-col overflow-hidden"
            >
              {/* Editor Header - n8n style */}
              <div className="h-16 border-b border-white/5 bg-[#111111] px-6 flex items-center justify-between z-20">
                <div className="flex items-center gap-6">
                  <div className="flex items-center gap-3">
                    <Button
                      variant="ghost"
                      size="icon"
                      className="h-9 w-9 rounded-xl hover:bg-white/5 border border-white/5"
                      onClick={() => setViewMode("templates")}
                    >
                      <ArrowLeft className="h-4 w-4" />
                    </Button>
                    <div className="flex flex-col">
                      <div className="flex items-center gap-2">
                        <Input
                          value={workflowName}
                          onChange={(e) => setWorkflowName(e.target.value)}
                          className="bg-transparent border-none text-sm font-black focus-visible:ring-0 w-auto p-0 h-auto text-white uppercase tracking-tighter"
                        />
                        <Edit2 className="h-3 w-3 text-white/20" />
                      </div>
                      <span className="text-[10px] font-medium text-muted-foreground uppercase tracking-widest opacity-50">
                        Workflow Automatis√©
                      </span>
                    </div>
                  </div>

                  {selectedTemplate && (
                    <div className="hidden md:block">
                      <Badge
                        variant="outline"
                        className="text-[9px] font-black uppercase border-primary/20 text-primary bg-primary/5 px-3 py-1"
                      >
                        {workflowTemplates.find((t) => t.id === selectedTemplate)?.name}
                      </Badge>
                    </div>
                  )}
                </div>

                <div className="flex items-center gap-3">
                  <div className="hidden lg:flex items-center gap-1 bg-black/40 p-1 rounded-xl border border-white/5 mr-2">
                    <Button
                      variant="ghost"
                      size="sm"
                      className={`text-[10px] font-black uppercase tracking-widest h-8 px-4 rounded-lg transition-all ${rightPanelTab === "simulate" ? "bg-white/10 text-white" : "text-muted-foreground"}`}
                      onClick={() => {
                        setRightPanelTab("simulate");
                        setIsRightPanelOpen(true);
                      }}
                    >
                      Test
                    </Button>
                    <Button
                      variant="ghost"
                      size="sm"
                      className={`text-[10px] font-black uppercase tracking-widest h-8 px-4 rounded-lg transition-all ${rightPanelTab === "logs" ? "bg-white/10 text-white" : "text-muted-foreground"}`}
                      onClick={() => {
                        setRightPanelTab("logs");
                        setIsRightPanelOpen(true);
                      }}
                    >
                      Logs
                    </Button>
                  </div>

                  <div className="h-8 w-px bg-white/5 mx-1" />

                  <Button
                    variant="ghost"
                    size="sm"
                    className="text-[10px] font-black uppercase tracking-widest gap-2 bg-white/5 hover:bg-white/10 border border-white/5"
                    onClick={handleManualSave}
                    disabled={isSaving}
                  >
                    {isSaving ? <Loader2 className="h-3 w-3 animate-spin" /> : <Save className="h-3 w-3" />}
                    Sauver
                  </Button>

                  <Button
                    size="sm"
                    className="bg-primary hover:bg-primary/90 text-black font-black text-[10px] uppercase tracking-widest gap-2 px-6 h-9 shadow-[0_0_20px_rgba(37,211,102,0.2)] rounded-xl"
                    onClick={() => setShowPublishModal(true)}
                  >
                    D√©ployer
                    <Rocket className="h-3.5 w-3.5" />
                  </Button>
                </div>
              </div>

              <div className="flex-1 flex overflow-hidden">
                {/* Nodes Palette - Left Panel */}
                <aside className="w-72 border-r border-white/10 bg-card/60 flex flex-col overflow-hidden">
                  <div className="p-4 border-b border-white/10">
                    <h3 className="text-xs font-bold uppercase tracking-widest text-muted-foreground mb-2">
                      Blocs Disponibles
                    </h3>
                    <p className="text-[10px] text-muted-foreground/60">
                      Glissez les blocs sur le canvas pour construire votre
                      workflow
                    </p>
                  </div>

                  <div className="flex-1 overflow-y-auto p-3 space-y-2">
                    {nodeCategories.map((category) => (
                      <div
                        key={category.id}
                        className="rounded-xl overflow-hidden border border-white/5"
                      >
                        <button
                          onClick={() =>
                            setExpandedCategory(
                              expandedCategory === category.id
                                ? null
                                : category.id,
                            )
                          }
                          className="w-full p-3 flex items-center justify-between bg-white/[0.02] hover:bg-white/[0.04] transition-colors"
                        >
                          <div className="flex items-center gap-2">
                            <category.icon className="h-4 w-4 text-primary" />
                            <span className="text-xs font-bold text-white">
                              {category.name}
                            </span>
                          </div>
                          <ChevronRight
                            className={`h-4 w-4 text-muted-foreground transition-transform ${expandedCategory === category.id ? "rotate-90" : ""}`}
                          />
                        </button>

                        <AnimatePresence>
                          {expandedCategory === category.id && (
                            <motion.div
                              initial={{ height: 0 }}
                              animate={{ height: "auto" }}
                              exit={{ height: 0 }}
                              className="overflow-hidden"
                            >
                              <div className="p-2 space-y-1 bg-black/20">
                                {category.nodes.map((node) => {
                                  const isTriggerType =
                                    category.id === "triggers";
                                  const isDisabled =
                                    isTriggerType && hasTrigger;

                                  return (
                                    <motion.div
                                      key={node.id}
                                      whileHover={isDisabled ? {} : { x: 4 }}
                                      className={`p-2.5 rounded-lg transition-all border border-transparent
                                                                                ${isDisabled ? "opacity-40 cursor-not-allowed grayscale bg-white/[0.01]" : "bg-white/[0.03] hover:bg-white/[0.06] cursor-pointer group hover:border-white/10"}
                                                                            `}
                                      onClick={() =>
                                        !isDisabled &&
                                        addNodeAtPosition(node.id, node.name)
                                      }
                                    >
                                      <div
                                        draggable={!isDisabled}
                                        onDragStart={(e) => {
                                          if (isDisabled) {
                                            e.preventDefault();
                                            return;
                                          }
                                          e.dataTransfer.setData(
                                            "nodeType",
                                            node.id,
                                          );
                                          e.dataTransfer.setData(
                                            "nodeName",
                                            node.name,
                                          );
                                        }}
                                        className="w-full h-full"
                                      >
                                        <div className="flex items-center gap-2">
                                          <node.icon
                                            className={`h-3.5 w-3.5 transition-colors ${isDisabled ? "text-muted-foreground" : "text-muted-foreground group-hover:text-primary"}`}
                                          />
                                          <span
                                            className={`text-[11px] font-medium transition-colors ${isDisabled ? "text-muted-foreground" : "text-white/80 group-hover:text-white"}`}
                                          >
                                            {node.name}
                                          </span>
                                        </div>
                                        <p className="text-[9px] text-muted-foreground/60 mt-1 pl-5">
                                          {node.description}
                                        </p>
                                      </div>
                                    </motion.div>
                                  );
                                })}
                              </div>
                            </motion.div>
                          )}
                        </AnimatePresence>
                      </div>
                    ))}
                  </div>

                  {/* Help Box */}
                  <div className="p-4 border-t border-white/10">
                    <div className="p-3 rounded-xl bg-primary/5 border border-primary/10">
                      <div className="flex items-center gap-2 mb-2">
                        <HelpCircle className="h-4 w-4 text-primary" />
                        <span className="text-[10px] font-bold text-primary uppercase">
                          Besoin d'aide ?
                        </span>
                      </div>
                      <p className="text-[9px] text-muted-foreground leading-relaxed">
                        Glissez un bloc du panneau de gauche sur le canvas pour
                        construire votre workflow. Testez avec le simulateur √†
                        droite.
                      </p>
                    </div>
                  </div>
                </aside>

                {/* Canvas Area - Free Form */}
                <div
                  className="flex-1 relative bg-background/50 overflow-auto select-none"
                  onMouseDown={handleCanvasMouseDown}
                  onMouseMove={handleCanvasMouseMove}
                  onMouseUp={handleCanvasMouseUp}
                  onMouseLeave={handleCanvasMouseUp}
                  onDragOver={(e) => e.preventDefault()}
                  onDrop={(e) => {
                    e.preventDefault();
                    const nodeType = e.dataTransfer.getData("nodeType");
                    const nodeName = e.dataTransfer.getData("nodeName");
                    if (!nodeType) return;

                    const rect = e.currentTarget.getBoundingClientRect();
                    const x = (e.clientX - rect.left) / zoom;
                    const y = (e.clientY - rect.top) / zoom;
                    addNodeAtPosition(nodeType, nodeName, x, y);
                  }}
                >
                  {/* Grid Background - scales with zoom */}
                  <div
                    className="absolute inset-0 opacity-[0.03] pointer-events-none bg-[radial-gradient(darkgray_1px,transparent_1px)]"
                    style={{ backgroundSize: `${32 * zoom}px ${32 * zoom}px` }}
                  />

                  {/* Zoom Controls - Bottom Left */}
                  <div className="absolute bottom-4 left-4 z-50 flex items-center gap-2">
                    {/* Zoom Panel */}
                    <div className="flex items-center gap-1 bg-[#171717] rounded-xl border border-white/10 p-1 shadow-xl">
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          handleZoomOut();
                        }}
                        className="h-8 w-8 rounded-lg hover:bg-white/10 flex items-center justify-center text-muted-foreground hover:text-white transition-colors"
                        title="D√©zoomer"
                      >
                        <ZoomOut className="h-4 w-4" />
                      </button>
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          handleZoomReset();
                        }}
                        className="h-8 px-2 rounded-lg hover:bg-white/10 flex items-center justify-center text-xs font-bold text-muted-foreground hover:text-white transition-colors min-w-[48px]"
                        title="R√©initialiser le zoom"
                      >
                        {Math.round(zoom * 100)}%
                      </button>
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          handleZoomIn();
                        }}
                        className="h-8 w-8 rounded-lg hover:bg-white/10 flex items-center justify-center text-muted-foreground hover:text-white transition-colors"
                        title="Zoomer"
                      >
                        <ZoomIn className="h-4 w-4" />
                      </button>
                      <div className="w-px h-6 bg-white/10 mx-1" />
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          handleZoomFit();
                        }}
                        className="h-8 w-8 rounded-lg hover:bg-white/10 flex items-center justify-center text-muted-foreground hover:text-white transition-colors"
                        title="Vue d'overview"
                      >
                        <Maximize2 className="h-4 w-4" />
                      </button>
                    </div>

                    {/* Selection Indicator */}
                    {selectedNodeIds.size > 0 && (
                      <div className="flex items-center gap-2 bg-[#87a9ff]/10 rounded-xl border border-[#87a9ff]/20 px-3 py-1.5 shadow-xl">
                        <span className="text-xs font-bold text-[#87a9ff]">
                          {selectedNodeIds.size} s√©lectionn√©
                          {selectedNodeIds.size > 1 ? "s" : ""}
                        </span>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            setSelectedNodeIds(new Set());
                          }}
                          className="h-6 w-6 rounded-md hover:bg-[#87a9ff]/20 flex items-center justify-center text-[#87a9ff] transition-colors"
                          title="D√©s√©lectionner tout"
                        >
                          <X className="h-3 w-3" />
                        </button>
                      </div>
                    )}

                    {/* Connection Mode Indicator */}
                    {connectingFrom !== null && (
                      <div className="flex items-center gap-2 bg-emerald-500/10 rounded-xl border border-emerald-500/30 px-3 py-1.5 shadow-xl animate-pulse">
                        <div className="h-2 w-2 rounded-full bg-emerald-400 animate-ping" />
                        <span className="text-xs font-bold text-emerald-400">
                          Connexion en cours...
                        </span>
                        <button
                          onClick={(e) => {
                            e.stopPropagation();
                            setConnectingFrom(null);
                          }}
                          className="h-6 w-6 rounded-md hover:bg-emerald-500/20 flex items-center justify-center text-emerald-400 transition-colors"
                          title="Annuler"
                        >
                          <X className="h-3 w-3" />
                        </button>
                      </div>
                    )}
                  </div>

                  {/* Canvas Content - with zoom transform */}
                  <div
                    className="relative origin-top-left transition-transform duration-200"
                    style={{
                      width: `${2000 * zoom}px`,
                      height: `${1500 * zoom}px`,
                      transform: `scale(${zoom})`,
                      transformOrigin: "top left",
                    }}
                  >
                    <div className="relative w-[2000px] h-[1500px] n8n-grid">
                      {/* Selection Rectangle Overlay */}
                      {selectionRect && (
                        <div
                          className="absolute border-2 border-[#87a9ff] bg-[#87a9ff]/10 pointer-events-none z-[2000] rounded-sm shadow-[0_0_15px_rgba(135,169,255,0.2)]"
                          style={{
                            left: Math.min(selectionRect.x1, selectionRect.x2),
                            top: Math.min(selectionRect.y1, selectionRect.y2),
                            width: Math.abs(
                              selectionRect.x1 - selectionRect.x2,
                            ),
                            height: Math.abs(
                              selectionRect.y1 - selectionRect.y2,
                            ),
                          }}
                        />
                      )}
                      {nodes.length === 0 ? (
                        <div className="absolute inset-0 flex flex-col items-center justify-center text-center p-12">
                          <div className="relative mb-8">
                            <div className="absolute inset-0 bg-primary/20 blur-[60px] rounded-full" />
                            <div className="relative h-20 w-20 rounded-3xl bg-white/5 border border-white/10 flex items-center justify-center shadow-2xl">
                              <Plus className="h-10 w-10 text-primary animate-pulse" />
                            </div>
                          </div>
                          <h3 className="text-2xl font-black text-white mb-3 italic uppercase tracking-tight">
                            Construisez votre Workflow
                          </h3>
                          <p className="text-sm text-muted-foreground max-w-xs leading-relaxed">
                            Glissez un bloc du panneau de gauche ou choisissez
                            un template pour commencer l'automatisation.
                          </p>
                        </div>
                      ) : (
                        <>
                          {/* Connection lines between nodes (SVG) */}
                          <svg
                            className="absolute inset-0 w-full h-full pointer-events-none"
                            style={{ zIndex: 0 }}
                          >
                            {nodes.map((node, idx) => {
                              // Skip if this node is explicitly disconnected (connectedTo = -1)
                              if (node.connectedTo === -1) {
                                return null;
                              }

                              // Determine target node: explicit connectedTo or next sequential
                              let targetNode: WorkflowNode | undefined;
                              if (
                                node.connectedTo !== undefined &&
                                node.connectedTo !== -1
                              ) {
                                // Explicit connection
                                targetNode = nodes.find(
                                  (n) => n.id === node.connectedTo,
                                );
                              } else if (idx < nodes.length - 1) {
                                // Default sequential connection
                                targetNode = nodes[idx + 1];
                              }

                              if (targetNode) {
                                // Port offsets: boxes are fixed 96x96
                                const startX = node.x + 96;
                                const startY = node.y + 48; // Center of 96px box
                                const endX = targetNode.x;
                                const endY = targetNode.y + 48;

                                // Dynamic curve offset based on distance
                                const dist = Math.abs(endX - startX);
                                const cpOffset = Math.min(dist * 0.4, 120);

                                const midX = (startX + endX) / 2;
                                const midY = (startY + endY) / 2;

                                const pathD = `M ${startX} ${startY} C ${startX + cpOffset} ${startY}, ${endX - cpOffset} ${endY}, ${endX} ${endY}`;

                                return (
                                  <g
                                    key={`line-${node.id}-${targetNode.id}`}
                                    className="group/line"
                                  >
                                    {/* Base connection line */}
                                    <path
                                      d={pathD}
                                      stroke={activeStep === idx + 0.5 ? "#3b82f6" : nodeStatuses[node.id] === "success" ? "#10b981" : nodeStatuses[node.id] === "error" ? "#ef4444" : "#87a9ff"}
                                      strokeWidth={activeStep === idx + 0.5 ? "4" : "3"}
                                      fill="none"
                                      strokeOpacity={activeStep === idx + 0.5 ? "1" : nodeStatuses[node.id] ? "0.8" : "0.4"}
                                      strokeLinecap="round"
                                      className="transition-all duration-300"
                                    />

                                    {/* Glow effect when wire is active */}
                                    {activeStep === idx + 0.5 && (
                                      <path
                                        d={pathD}
                                        stroke="#3b82f6"
                                        strokeWidth="8"
                                        fill="none"
                                        strokeOpacity="0.3"
                                        strokeLinecap="round"
                                        className="animate-pulse"
                                      />
                                    )}

                                    {/* Flow Animation Particle - n8n style */}
                                    <AnimatePresence>
                                      {activeStep === idx + 0.5 && (
                                        <>
                                          {/* Main particle */}
                                          <motion.circle
                                            r="6"
                                            fill="#3b82f6"
                                            initial={{
                                              opacity: 0,
                                              offsetDistance: "0%",
                                            }}
                                            animate={{
                                              opacity: 1,
                                              offsetDistance: "100%",
                                            }}
                                            exit={{ opacity: 0 }}
                                            transition={{
                                              offsetDistance: {
                                                duration: 0.6,
                                                ease: "easeOut",
                                              },
                                              opacity: { duration: 0.1 },
                                            }}
                                            style={{
                                              offsetPath: `path('${pathD}')`,
                                              filter: "drop-shadow(0 0 15px #3b82f6)",
                                            }}
                                          />
                                          {/* Trail particle */}
                                          <motion.circle
                                            r="4"
                                            fill="white"
                                            initial={{
                                              opacity: 0,
                                              offsetDistance: "0%",
                                            }}
                                            animate={{
                                              opacity: [0, 0.8, 0],
                                              offsetDistance: "100%",
                                            }}
                                            transition={{
                                              offsetDistance: {
                                                duration: 0.6,
                                                ease: "easeOut",
                                                delay: 0.05,
                                              },
                                              opacity: { duration: 0.6 },
                                            }}
                                            style={{
                                              offsetPath: `path('${pathD}')`,
                                              filter: "drop-shadow(0 0 8px white)",
                                            }}
                                          />
                                        </>
                                      )}
                                    </AnimatePresence>
                                    <g
                                      className="cursor-pointer pointer-events-auto group/btn"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        setNodePickerPos({
                                          x: midX,
                                          y: midY,
                                          index: idx + 1,
                                        });
                                      }}
                                      onMouseDown={(e) => e.stopPropagation()}
                                    >
                                      {/* Transparent HIT AREA larger than the visual button */}
                                      <circle
                                        cx={midX}
                                        cy={midY}
                                        r="20"
                                        fill="transparent"
                                      />

                                      <circle
                                        cx={midX}
                                        cy={midY}
                                        r="12"
                                        fill="#171717"
                                        stroke="#3f3f46"
                                        className="group-hover/btn:stroke-primary group-hover/line:stroke-primary group-hover/btn:scale-110 transition-all origin-center"
                                        style={{ transformBox: "fill-box" }}
                                      />
                                      <path
                                        d={`M ${midX - 3} ${midY} L ${midX + 3} ${midY} M ${midX} ${midY - 3} L ${midX} ${midY + 3}`}
                                        stroke="white"
                                        strokeWidth="1.5"
                                        strokeLinecap="round"
                                        className="pointer-events-none group-hover/btn:scale-110 transition-all origin-center"
                                        style={{ transformBox: "fill-box" }}
                                      />
                                    </g>

                                    {/* Disconnect Button - appears on hover */}
                                    <g
                                      className="cursor-pointer pointer-events-auto group/disconnect opacity-0 group-hover/line:opacity-100 transition-opacity"
                                      onClick={(e) => {
                                        e.stopPropagation();
                                        // Mark the current node as disconnected from the next
                                        setNodes((prevNodes) =>
                                          prevNodes.map((n) =>
                                            n.id === node.id
                                              ? { ...n, connectedTo: -1 }
                                              : n,
                                          ),
                                        );
                                      }}
                                      onMouseDown={(e) => e.stopPropagation()}
                                    >
                                      <circle
                                        cx={midX + 30}
                                        cy={midY}
                                        r="14"
                                        fill="transparent"
                                      />
                                      <circle
                                        cx={midX + 30}
                                        cy={midY}
                                        r="10"
                                        fill="#171717"
                                        stroke="#ef4444"
                                        strokeOpacity="0.6"
                                        className="group-hover/disconnect:stroke-opacity-100 group-hover/disconnect:fill-red-500/10 transition-all"
                                      />
                                      <path
                                        d={`M ${midX + 30 - 3} ${midY - 3} L ${midX + 30 + 3} ${midY + 3} M ${midX + 30 + 3} ${midY - 3} L ${midX + 30 - 3} ${midY + 3}`}
                                        stroke="#ef4444"
                                        strokeWidth="1.5"
                                        strokeLinecap="round"
                                        className="pointer-events-none"
                                      />
                                    </g>
                                  </g>
                                );
                              }
                              return null;
                            })}

                            {/* Temporary connection line when dragging */}
                            {connectingFrom !== null &&
                              (() => {
                                const sourceNode = nodes.find(
                                  (n) => n.id === connectingFrom,
                                );
                                if (!sourceNode) return null;

                                const startX = sourceNode.x + 96;
                                const startY = sourceNode.y + 48;
                                const endX = mousePos.x;
                                const endY = mousePos.y;

                                const dist = Math.abs(endX - startX);
                                const cpOffset = Math.min(dist * 0.4, 120);

                                const pathD = `M ${startX} ${startY} C ${startX + cpOffset} ${startY}, ${endX - cpOffset} ${endY}, ${endX} ${endY}`;

                                return (
                                  <path
                                    d={pathD}
                                    stroke="#87a9ff"
                                    strokeWidth="3"
                                    fill="none"
                                    strokeOpacity="0.8"
                                    strokeLinecap="round"
                                    strokeDasharray="8 4"
                                    className="animate-pulse"
                                  />
                                );
                              })()}
                          </svg>

                          {/* Draggable Nodes */}
                          {nodes.map((node, idx) => {
                            const nodeInfo = getNodeInfo(node.type);
                            return (
                              <DraggableNode
                                key={node.id}
                                node={node}
                                nodeInfo={nodeInfo}
                                isSelected={selectedNodeIds.has(node.id)}
                                isActiveStep={activeStep === idx}
                                executionStatus={nodeStatuses[node.id]}
                                onPositionChange={handlePositionChange}
                                onSelect={() => {
                                  setRightPanelTab("inspect");
                                  setIsRightPanelOpen(true);
                                }}
                                onDelete={() =>
                                  setNodes(
                                    nodes.filter((n) => n.id !== node.id),
                                  )
                                }
                                zoom={zoom}
                                onNodeSelectOnly={(e) =>
                                  handleNodeSelect(node.id, e)
                                }
                                onOpenSettings={() => {
                                  setSelectedNodeIds(new Set([node.id]));
                                  setRightPanelTab("inspect");
                                  setIsRightPanelOpen(true);
                                }}
                                onStartConnect={() => {
                                  setConnectingFrom(node.id);
                                  setMousePos({
                                    x: node.x + 96,
                                    y: node.y + 48,
                                  });
                                }}
                                onCompleteConnect={() =>
                                  handleNodeConnect(node.id)
                                }
                                onAddNext={() =>
                                  setNodePickerPos({
                                    x: node.x + 140,
                                    y: node.y,
                                    index: idx + 1,
                                  })
                                }
                                isConnecting={connectingFrom !== null}
                                isStartingConnection={connectingFrom === node.id}
                                isTargetable={connectingFrom !== null && connectingFrom !== node.id}
                                isDisconnected={node.connectedTo === -1}
                                isWhatsAppConnected={isWhatsAppConnected}
                              />
                            );
                          })}

                          {/* Floating Node Picker for Insertion */}
                          <AnimatePresence>
                            {nodePickerPos && (
                              <motion.div
                                initial={{ opacity: 0, scale: 0.9, y: 10 }}
                                animate={{ opacity: 1, scale: 1, y: 0 }}
                                exit={{ opacity: 0, scale: 0.9, y: 10 }}
                                className="absolute z-[3000] bg-[#171717] border border-white/10 rounded-2xl shadow-2xl p-4 w-[280px] backdrop-blur-xl"
                                style={{
                                  left: nodePickerPos.x - 140,
                                  top: nodePickerPos.y + 20,
                                }}
                              >
                                <h4 className="text-[10px] font-black uppercase tracking-widest text-muted-foreground mb-3 px-2">
                                  Ins√©rer un bloc
                                </h4>
                                <div className="space-y-4 max-h-[300px] overflow-y-auto custom-scrollbar pr-1">
                                  {nodeCategories.map((category) => (
                                    <div
                                      key={category.id}
                                      className="space-y-1"
                                    >
                                      <p className="text-[8px] font-black uppercase text-white/30 px-2">
                                        {category.name}
                                      </p>
                                      <div className="grid grid-cols-1 gap-1">
                                        {category.nodes.map((node) => {
                                          const isTriggerType =
                                            category.id === "triggers";
                                          const isDisabled =
                                            isTriggerType && hasTrigger;

                                          return (
                                            <button
                                              key={node.id}
                                              disabled={isDisabled}
                                              onClick={() =>
                                                insertNode(
                                                  nodePickerPos.index,
                                                  node.id,
                                                  node.name,
                                                  nodePickerPos.x - 48,
                                                  nodePickerPos.y - 24,
                                                )
                                              }
                                              className={`flex items-center gap-3 p-2 rounded-lg text-left transition-colors
                                                                                                ${isDisabled ? "opacity-40 cursor-not-allowed grayscale" : "hover:bg-white/5 group"}
                                                                                            `}
                                            >
                                              <div
                                                className={`h-7 w-7 rounded-md bg-white/5 flex items-center justify-center ${isDisabled ? "" : "group-hover:bg-primary/20"} transition-colors`}
                                              >
                                                <node.icon
                                                  className={`h-3.5 w-3.5 ${isDisabled ? "text-muted-foreground" : "text-muted-foreground group-hover:text-primary"}`}
                                                />
                                              </div>
                                              <span
                                                className={`text-xs font-medium ${isDisabled ? "text-muted-foreground" : "text-white/80 group-hover:text-white"}`}
                                              >
                                                {node.name}
                                              </span>
                                            </button>
                                          );
                                        })}
                                      </div>
                                    </div>
                                  ))}
                                </div>
                              </motion.div>
                            )}
                          </AnimatePresence>
                        </>
                      )}
                    </div>
                  </div>
                </div>

                {/* Floating Right Panel - Drawer Style */}
                <AnimatePresence>
                  {isRightPanelOpen && (
                    <motion.aside
                      initial={{ x: "100%" }}
                      animate={{ x: 0 }}
                      exit={{ x: "100%" }}
                      transition={{
                        type: "spring",
                        damping: 25,
                        stiffness: 200,
                      }}
                      className="absolute top-4 right-4 bottom-4 w-[400px] z-[100] bg-[#171717]/80 backdrop-blur-xl border border-white/10 rounded-3xl flex flex-col shadow-[0_0_50px_rgba(0,0,0,0.5)] overflow-hidden"
                    >
                      <div className="flex p-2 gap-1 border-b border-white/10 bg-black/20 relative">
                        <button
                          onClick={() => setRightPanelTab("inspect")}
                          className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-[9px] font-bold uppercase tracking-widest transition-all ${rightPanelTab === "inspect"
                            ? "bg-white/10 text-white"
                            : "text-muted-foreground hover:bg-white/5"
                            }`}
                        >
                          <Settings className="h-3 w-3" /> Configuration
                        </button>
                        <button
                          onClick={() => setRightPanelTab("simulate")}
                          className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-[9px] font-bold uppercase tracking-widest transition-all ${rightPanelTab === "simulate"
                            ? "bg-white/10 text-white"
                            : "text-muted-foreground hover:bg-white/5"
                            }`}
                        >
                          <Play className="h-3 w-3" /> Simulateur
                        </button>
                        <button
                          onClick={() => setRightPanelTab("logs")}
                          className={`flex-1 flex items-center justify-center gap-2 py-2 rounded-xl text-[9px] font-bold uppercase tracking-widest transition-all ${rightPanelTab === "logs"
                            ? "bg-white/10 text-white"
                            : "text-muted-foreground hover:bg-white/5"
                            }`}
                        >
                          <Terminal className="h-3 w-3" /> Logs
                          {executionLogs.some((l) => typeof l === 'string' && l.includes("[ERROR]")) && (
                            <span className="flex h-1.5 w-1.5 rounded-full bg-red-500 animate-pulse" />
                          )}
                        </button>
                      </div>

                      <div className="flex-1 overflow-y-auto p-4 custom-scrollbar">
                        {rightPanelTab === "logs" ? (
                          <div className="space-y-4">
                            <div className="flex items-center justify-between">
                              <h3 className="text-[10px] font-black uppercase tracking-widest text-muted-foreground">
                                Historique d'ex√©cution
                              </h3>
                              <button
                                onClick={() => setExecutionLogs([])}
                                className="text-[9px] text-muted-foreground/60 hover:text-white transition-colors"
                              >
                                Effacer tout
                              </button>
                            </div>

                            {executionLogs.length === 0 ? (
                              <div className="text-center py-20 opacity-20">
                                <Activity className="h-12 w-12 mx-auto mb-4" />
                                <p className="text-xs">Aucun log r√©cent</p>
                                <p className="text-[9px] mt-2 opacity-60">Ex√©cutez un workflow pour voir les logs</p>
                              </div>
                            ) : (
                              <div className="space-y-3">
                                {/* Execution Summary Header */}
                                <div className="bg-white/5 rounded-xl p-3 border border-white/10">
                                  <div className="flex items-center justify-between mb-2">
                                    <div className="flex items-center gap-2">
                                      <div className="h-2 w-2 rounded-full bg-emerald-500 animate-pulse" />
                                      <span className="text-[10px] font-bold text-white">Ex√©cution termin√©e</span>
                                    </div>
                                    <span className="text-[9px] text-muted-foreground">
                                      {executionLogs.length} √©tape{executionLogs.length > 1 ? 's' : ''}
                                    </span>
                                  </div>
                                  <div className="flex gap-4 text-[9px]">
                                    <div className="flex items-center gap-1">
                                      <CheckCircle2 className="h-3 w-3 text-emerald-500" />
                                      <span className="text-emerald-400">{executionLogs.filter((l: any) => l.status === 'success').length} succ√®s</span>
                                    </div>
                                    <div className="flex items-center gap-1">
                                      <XCircle className="h-3 w-3 text-red-500" />
                                      <span className="text-red-400">{executionLogs.filter((l: any) => l.status === 'error').length} erreur</span>
                                    </div>
                                    <div className="flex items-center gap-1">
                                      <Clock className="h-3 w-3 text-muted-foreground" />
                                      <span className="text-muted-foreground">{executionLogs.reduce((acc: number, l: any) => acc + (l.duration || 0), 0)}ms</span>
                                    </div>
                                  </div>
                                </div>

                                {/* Individual Step Logs - n8n Style */}
                                {executionLogs.map((log: any, i: number) => {
                                  const isRichLog = typeof log === 'object' && log.nodeType;
                                  const status = isRichLog ? log.status : (typeof log === 'string' && log.includes('[ERROR]') ? 'error' : 'success');
                                  const nodeName = isRichLog ? log.nodeName : '√âtape';
                                  const nodeType = isRichLog ? log.nodeType : 'unknown';
                                  const message = isRichLog ? log.message : (typeof log === 'string' ? log.replace(/\[.*?\]\s*/, '') : String(log));
                                  const duration = isRichLog ? log.duration : null;
                                  const timestamp = isRichLog && log.timestamp ? new Date(log.timestamp).toLocaleTimeString() : '';
                                  const stepNumber = isRichLog ? log.stepNumber : i + 1;
                                  const outputData = isRichLog ? log.output?.data : null;

                                  return (
                                    <div
                                      key={i}
                                      className={`rounded-xl border overflow-hidden transition-all hover:border-white/20
                                        ${status === 'success' ? 'bg-emerald-500/5 border-emerald-500/20' : ''}
                                        ${status === 'error' ? 'bg-red-500/5 border-red-500/20' : ''}
                                        ${status === 'warning' ? 'bg-orange-500/5 border-orange-500/20' : ''}
                                        ${status === 'skipped' ? 'bg-zinc-500/5 border-zinc-500/20' : ''}
                                      `}
                                    >
                                      {/* Step Header */}
                                      <div className="flex items-center justify-between px-3 py-2 bg-white/5">
                                        <div className="flex items-center gap-2">
                                          <div className={`flex items-center justify-center h-5 w-5 rounded-md text-[9px] font-bold
                                            ${status === 'success' ? 'bg-emerald-500/20 text-emerald-400' : ''}
                                            ${status === 'error' ? 'bg-red-500/20 text-red-400' : ''}
                                            ${status === 'warning' ? 'bg-orange-500/20 text-orange-400' : ''}
                                            ${status === 'skipped' ? 'bg-zinc-500/20 text-zinc-400' : ''}
                                          `}>
                                            {stepNumber}
                                          </div>
                                          <div>
                                            <div className="text-[10px] font-bold text-white">{nodeName}</div>
                                            <div className="text-[8px] text-muted-foreground font-mono">{nodeType}</div>
                                          </div>
                                        </div>
                                        <div className="flex items-center gap-2">
                                          {duration && (
                                            <span className="text-[8px] text-muted-foreground bg-white/5 px-2 py-0.5 rounded-full">
                                              {duration}ms
                                            </span>
                                          )}
                                          <div className={`h-2 w-2 rounded-full
                                            ${status === 'success' ? 'bg-emerald-500' : ''}
                                            ${status === 'error' ? 'bg-red-500' : ''}
                                            ${status === 'warning' ? 'bg-orange-500' : ''}
                                            ${status === 'skipped' ? 'bg-zinc-500' : ''}
                                          `} />
                                        </div>
                                      </div>

                                      {/* Step Content */}
                                      <div className="px-3 py-2 space-y-2">
                                        {/* Output Message */}
                                        <div className="flex items-start gap-2">
                                          <ArrowRight className="h-3 w-3 text-muted-foreground mt-0.5 shrink-0" />
                                          <p className="text-[10px] text-white/80">{message}</p>
                                        </div>

                                        {/* Output Data (if any) */}
                                        {outputData && (
                                          <div className="mt-2 bg-black/20 rounded-lg p-2">
                                            <div className="text-[8px] font-bold text-muted-foreground uppercase mb-1">Donn√©es de sortie</div>
                                            <pre className="text-[9px] text-emerald-400 font-mono overflow-x-auto">
                                              {JSON.stringify(outputData, null, 2)}
                                            </pre>
                                          </div>
                                        )}

                                        {/* Timestamp */}
                                        {timestamp && (
                                          <div className="flex items-center gap-1 pt-1 border-t border-white/5">
                                            <Clock className="h-2.5 w-2.5 text-muted-foreground/50" />
                                            <span className="text-[8px] text-muted-foreground/50">{timestamp}</span>
                                          </div>
                                        )}
                                      </div>
                                    </div>
                                  );
                                })}
                              </div>
                            )}
                          </div>
                        ) : rightPanelTab === "simulate" ? (
                          <div className="space-y-6">
                            <div className="flex justify-center flex-1">
                              <WhatsAppSimulator
                                isProduction={false}
                                userId={automationId}
                                template={
                                  (selectedTemplate as
                                    | "support"
                                    | "ecommerce"
                                    | "appointment"
                                    | "default") || "default"
                                }
                                onExecutionResult={handleExecutionResult}
                                setIsFlowAnimate={setIsFlowAnimate}
                                setExecutionSequence={setExecutionSequence}
                                setActiveStep={setActiveStep}
                                setNodeStatuses={setNodeStatuses}
                                nodes={nodes}
                                products={products}
                                currency="FCFA"
                                targetPhoneNumber={clientWhatsAppNumber}
                              />
                            </div>

                            <div className="p-4 rounded-xl bg-primary/5 border border-primary/10">
                              <div className="flex items-center gap-2 mb-2">
                                <Zap className="h-4 w-4 text-primary" />
                                <span className="text-[10px] font-bold text-primary uppercase">
                                  Mode Test Actif
                                </span>
                              </div>
                              <p className="text-[9px] text-muted-foreground leading-relaxed">
                                Utilisez ce simulateur pour tester la logique de
                                votre bot en toute s√©curit√©. Pour envoyer de
                                vrais messages, utilisez le bouton{" "}
                                <b>Publier</b>.
                              </p>
                            </div>
                          </div>
                        ) : (
                          <div>
                            {selectedNodeIds.size === 1 ? (
                              (() => {
                                const selectedId =
                                  Array.from(selectedNodeIds)[0];
                                const node = nodes.find(
                                  (n) => n.id === selectedId,
                                );
                                const nodeInfo = node
                                  ? getNodeInfo(node.type)
                                  : null;

                                if (!node)
                                  return (
                                    <div className="text-center text-muted-foreground p-8">
                                      <Settings className="h-12 w-12 mx-auto mb-4 opacity-20" />
                                      <p className="text-sm">
                                        Noeud introuvable
                                      </p>
                                    </div>
                                  );

                                return (
                                  <div className="flex flex-col h-full bg-[#111111]">
                                    {/* n8n Style Configuration Header */}
                                    <div className="p-6 border-b border-white/5 bg-black/40">
                                      <div className="flex items-center gap-4 mb-2">
                                        <div className={`h-12 w-12 rounded-xl flex items-center justify-center border-2 ${nodeInfo?.category?.id === 'triggers' ? 'border-emerald-500/30 bg-emerald-500/5' : 'border-zinc-700 bg-white/5'}`}>
                                          {nodeInfo && <nodeInfo.icon className={`h-6 w-6 ${nodeInfo?.category?.id === 'triggers' ? 'text-emerald-400' : 'text-zinc-400'}`} />}
                                        </div>
                                        <div className="flex-1 min-w-0">
                                          <div className="flex items-center gap-2 mb-0.5">
                                            <span className="text-[10px] font-black text-muted-foreground uppercase tracking-widest">
                                              {nodeInfo?.category?.name || "Action"}
                                            </span>
                                            <div className="h-1 w-1 rounded-full bg-white/20" />
                                            <span className="text-[10px] font-medium text-white/40">
                                              #{node.id}
                                            </span>
                                          </div>
                                          <h3 className="text-xl font-black text-white uppercase tracking-tighter truncate leading-none">
                                            {node.name}
                                          </h3>
                                        </div>
                                      </div>
                                    </div>

                                    <div className="flex-1 overflow-y-auto p-6 space-y-8 custom-scrollbar">
                                      {/* Common Settings Section */}
                                      <div className="space-y-6">
                                        <div className="space-y-3">
                                          <label className="text-[10px] font-black uppercase text-white/40 tracking-widest flex items-center gap-2">
                                            <div className="h-1.5 w-1.5 rounded-full bg-primary" />
                                            Nom de l'√©tape
                                          </label>
                                          <Input
                                            value={node.name}
                                            onChange={(e) => {
                                              setNodes(
                                                nodes.map((n) =>
                                                  n.id === node.id
                                                    ? {
                                                      ...n,
                                                      name: e.target.value,
                                                    }
                                                    : n,
                                                ),
                                              );
                                            }}
                                            className="bg-white/5 border-white/10 h-10 focus:border-primary/50 transition-colors text-xs"
                                          />
                                        </div>

                                        <div className="p-4 rounded-2xl bg-gradient-to-br from-white/5 to-transparent border border-white/10 shadow-inner">
                                          <div className="flex items-center gap-4 mb-4">
                                            <div
                                              className={`h-12 w-12 rounded-xl flex items-center justify-center shadow-lg ${nodeInfo?.category?.id ===
                                                "triggers"
                                                ? "bg-emerald-500/20 text-emerald-400 border border-emerald-500/30"
                                                : nodeInfo?.category?.id ===
                                                  "ai"
                                                  ? "bg-purple-500/20 text-purple-400 border border-purple-500/30"
                                                  : "bg-primary/20 text-primary border border-primary/30"
                                                }`}
                                            >
                                              {nodeInfo ? (
                                                <nodeInfo.icon className="h-6 w-6" />
                                              ) : (
                                                <Zap className="h-6 w-6" />
                                              )}
                                            </div>
                                            <div>
                                              <p className="text-sm font-black text-white uppercase tracking-tight">
                                                {nodeInfo?.name || node.type}
                                              </p>
                                              <p className="text-[10px] text-muted-foreground uppercase font-black tracking-widest opacity-60">
                                                {nodeInfo?.category?.name ||
                                                  "Action"}
                                              </p>
                                            </div>
                                          </div>
                                          <div className="h-px bg-white/5 w-full mb-3" />
                                          <p className="text-[11px] text-muted-foreground/80 leading-relaxed italic">
                                            {nodeInfo?.description ||
                                              "Configurez ce bloc pour d√©finir son comportement dans le workflow."}
                                          </p>
                                        </div>

                                        <div className="space-y-3 pt-2">
                                          <label className="text-[10px] font-bold uppercase text-muted-foreground px-1">
                                            Configuration Sp√©cifique
                                          </label>

                                          {(() => {
                                            // Helper to get/set JSON config
                                            const cfg = (defaultValue = {}) => {
                                              try {
                                                return {
                                                  ...defaultValue,
                                                  ...JSON.parse(node.config),
                                                };
                                              } catch (e) {
                                                return defaultValue;
                                              }
                                            };
                                            const updateCfg = (newCfg: any) => {
                                              setNodes(
                                                nodes.map((n) =>
                                                  n.id === node.id
                                                    ? {
                                                      ...n,
                                                      config:
                                                        JSON.stringify(
                                                          newCfg,
                                                        ),
                                                    }
                                                    : n,
                                                ),
                                              );
                                            };

                                            const currentCfg = cfg();

                                            const instructionsUI = (
                                              <div className="mt-6 pt-2 border-t border-white/5">
                                                <button
                                                  onClick={() =>
                                                    setIsAiInstructionsOpen(
                                                      !isAiInstructionsOpen,
                                                    )
                                                  }
                                                  className="w-full flex items-center justify-between p-2 rounded-lg hover:bg-white/5 transition-colors group"
                                                >
                                                  <div className="flex items-center gap-2">
                                                    <div className="h-5 w-5 rounded-lg bg-primary/10 flex items-center justify-center group-hover:bg-primary/20 transition-colors">
                                                      <Bot className="h-3 w-3 text-primary" />
                                                    </div>
                                                    <label className="text-[10px] font-black uppercase tracking-widest text-white/90 cursor-pointer">
                                                      Instructions IA
                                                    </label>
                                                  </div>
                                                  <ChevronRight
                                                    className={`h-3 w-3 text-white/40 transition-transform duration-200 ${isAiInstructionsOpen ? "rotate-90" : ""}`}
                                                  />
                                                </button>

                                                <AnimatePresence>
                                                  {isAiInstructionsOpen && (
                                                    <motion.div
                                                      initial={{
                                                        height: 0,
                                                        opacity: 0,
                                                      }}
                                                      animate={{
                                                        height: "auto",
                                                        opacity: 1,
                                                      }}
                                                      exit={{
                                                        height: 0,
                                                        opacity: 0,
                                                      }}
                                                      className="overflow-hidden"
                                                    >
                                                      <div className="pt-2 pb-1 space-y-3 px-1">
                                                        <textarea
                                                          value={
                                                            currentCfg.aiInstructions ||
                                                            ""
                                                          }
                                                          onChange={(e) =>
                                                            updateCfg({
                                                              ...currentCfg,
                                                              aiInstructions:
                                                                e.target.value,
                                                            })
                                                          }
                                                          className="w-full h-24 bg-black/40 border border-white/10 rounded-xl p-3 text-[11px] text-white/80 focus:border-primary/50 transition-all font-medium leading-relaxed resize-none"
                                                          placeholder="Ex: Sois tr√®s amical, ou ignore si le client semble agressif..."
                                                        />
                                                        <div className="flex items-center gap-2">
                                                          <Sparkles className="h-2.5 w-2.5 text-primary opacity-50" />
                                                          <p className="text-[8px] text-muted-foreground italic font-medium">
                                                            Guide le
                                                            comportement de l'IA
                                                            sp√©cifiquement pour
                                                            ce bloc.
                                                          </p>
                                                        </div>
                                                      </div>
                                                    </motion.div>
                                                  )}
                                                </AnimatePresence>
                                              </div>
                                            );
                                            return (
                                              <>
                                                <BlockConfigRenderer
                                                  node={node}
                                                  updateConfig={(config) => {
                                                    setNodes(
                                                      nodes.map((n) =>
                                                        n.id === node.id
                                                          ? { ...n, config: JSON.stringify(config) }
                                                          : n
                                                      )
                                                    );
                                                  }}
                                                  context={{
                                                    isClientWhatsAppConnected,
                                                    clientWhatsAppNumber,
                                                    isWhatsAppConnected,
                                                    automationId,
                                                    handleDisconnectWhatsApp,
                                                    isDisconnectingWhatsApp,
                                                    setShowConnectionModal,
                                                  }}
                                                />
                                                {instructionsUI}
                                              </>
                                            );
                                          })()}
                                        </div>
                                      </div>
                                    </div>

                                    <div className="pt-6 border-t border-white/5">
                                      <Button
                                        variant="ghost"
                                        className="w-full justify-start text-xs text-red-500/60 hover:text-red-500 hover:bg-red-500/5 gap-2"
                                        onClick={() => {
                                          setNodes(
                                            nodes.filter(
                                              (n) => n.id !== node.id,
                                            ),
                                          );
                                          setIsRightPanelOpen(false);
                                        }}
                                      >
                                        <Trash2 className="h-3.5 w-3.5" />{" "}
                                        Supprimer ce bloc
                                      </Button>
                                    </div>
                                  </div>
                                );
                              })()
                            ) : (
                              <div className="text-center text-muted-foreground p-8 h-full flex flex-col items-center justify-center">
                                <Settings className="h-12 w-12 mx-auto mb-4 opacity-10" />
                                <p className="text-sm">
                                  {selectedNodeIds.size > 1
                                    ? `${selectedNodeIds.size} blocs s√©lectionn√©s`
                                    : "S√©lectionnez un bloc pour voir ses options"}
                                </p>
                              </div>
                            )}
                          </div>
                        )}
                      </div>
                    </motion.aside>
                  )}
                </AnimatePresence>
              </div>
            </motion.div>
          )}

          {/* Mode: Products Management */}
          {viewMode === "products" && (
            <motion.div
              key="products"
              initial={{ opacity: 0 }}
              animate={{ opacity: 1 }}
              exit={{ opacity: 0 }}
              className="flex-1 flex flex-col overflow-hidden"
            >
              <div className="h-14 border-b border-white/10 bg-card px-6 flex items-center justify-between">
                <div className="flex items-center gap-4">
                  <Button
                    variant="ghost"
                    size="icon"
                    className="h-8 w-8"
                    onClick={() => setViewMode("builder")}
                  >
                    <ArrowLeft className="h-4 w-4" />
                  </Button>
                  <h2 className="text-sm font-bold">Gestion des Produits</h2>
                  <Badge variant="outline" className="text-xs">
                    {products.length} produits
                  </Badge>

                  <div className="flex items-center gap-1 border-l border-white/10 pl-4 ml-2">
                    {Object.entries(currencySymbols).map(([code, symbol]) => (
                      <button
                        key={code}
                        onClick={() => setCurrency(code as any)}
                        className={`px-2 py-1 rounded-md text-[10px] font-black transition-all ${currency === code
                          ? "bg-primary text-black"
                          : "text-white/40 hover:text-white/60 hover:bg-white/5"
                          }`}
                      >
                        {code}
                      </button>
                    ))}
                  </div>
                </div>
                <Button
                  size="sm"
                  className="bg-primary text-black font-bold text-xs gap-2 px-4"
                  onClick={() => setIsProductModalOpen(true)}
                >
                  <PlusCircle className="h-3.5 w-3.5" /> Ajouter un produit
                </Button>
              </div>

              <div className="flex-1 overflow-y-auto p-6">
                <div className="max-w-4xl mx-auto">
                  <div className="grid gap-4">
                    {products.map((product) => (
                      <Card
                        key={product.id}
                        className="border-white/10 bg-card overflow-hidden"
                      >
                        <CardContent className="p-4 flex items-center gap-4">
                          <div className="h-16 w-16 rounded-xl bg-white/5 flex items-center justify-center text-3xl overflow-hidden shrink-0">
                            {product.image.startsWith("http") ||
                              product.image.startsWith("data:image") ? (
                              <img
                                src={product.image}
                                className="w-full h-full object-cover"
                                alt={product.name}
                              />
                            ) : (
                              product.image
                            )}
                          </div>
                          <div className="flex-1 min-w-0">
                            <h3 className="font-bold text-white truncate">
                              {product.name}
                            </h3>
                            {product.description && (
                              <p className="text-[10px] text-muted-foreground line-clamp-2 leading-relaxed mt-0.5">
                                {product.description}
                              </p>
                            )}
                            <p className="text-[10px] text-muted-foreground/60 font-medium mt-1">
                              Stock: {product.stock} unit√©s
                            </p>
                          </div>
                          <div className="text-right shrink-0">
                            <p className="text-xl font-bold text-primary">
                              {product.price} {currencySymbols[currency]}
                            </p>
                          </div>
                          <div className="flex gap-2">
                            <Button
                              variant="ghost"
                              size="icon"
                              className="h-8 w-8"
                              onClick={() => {
                                setEditingProduct({
                                  ...product,
                                  labels: Array.isArray(product.labels)
                                    ? product.labels.join(", ")
                                    : product.labels,
                                });
                                setIsProductModalOpen(true);
                              }}
                            >
                              <Settings className="h-4 w-4" />
                            </Button>
                            <Button
                              variant="ghost"
                              size="icon"
                              className="h-8 w-8 text-red-500 hover:text-red-600 hover:bg-red-500/10"
                              onClick={() => handleDeleteProduct(product.id)}
                            >
                              <Trash2 className="h-4 w-4" />
                            </Button>
                          </div>
                        </CardContent>
                        {product.labels &&
                          Array.isArray(product.labels) &&
                          product.labels.length > 0 && (
                            <div className="px-4 pb-4 flex flex-wrap gap-2">
                              {product.labels.map(
                                (label: string, i: number) => (
                                  <Badge
                                    key={i}
                                    variant="secondary"
                                    className="bg-white/5 text-[10px] font-medium border-white/5"
                                  >
                                    {label}
                                  </Badge>
                                ),
                              )}
                            </div>
                          )}
                      </Card>
                    ))}
                  </div>
                </div>
              </div>
            </motion.div>
          )}
        </AnimatePresence>

        {/* Publication Modal */}
        <AnimatePresence>
          {showPublishModal && (
            <div className="fixed inset-0 z-[5000] flex items-center justify-center p-4">
              <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                onClick={() => setShowPublishModal(false)}
                className="absolute inset-0 bg-black/80 backdrop-blur-md"
              />
              <motion.div
                initial={{ opacity: 0, scale: 0.9, y: 20 }}
                animate={{ opacity: 1, scale: 1, y: 0 }}
                exit={{ opacity: 0, scale: 0.9, y: 20 }}
                className="relative w-full max-w-4xl bg-[#171717] border border-white/10 rounded-[40px] shadow-2xl overflow-hidden flex"
                style={{ height: "600px" }}
              >
                {/* Left Side: Info & Steps */}
                <div className="flex-1 p-12 flex flex-col justify-between border-r border-white/5">
                  <div>
                    <div className="h-14 w-14 rounded-2xl bg-primary/10 flex items-center justify-center mb-8">
                      {isTelegramWorkflow ? (
                        <TelegramIcon className="h-7 w-7" />
                      ) : (
                        <Rocket className="h-7 w-7 text-primary" />
                      )}
                    </div>
                    <h2 className="text-3xl font-black text-white mb-4 italic uppercase">
                      {isTelegramWorkflow
                        ? "Connecter Telegram"
                        : "Pr√™t √† Publier ?"}
                    </h2>
                    <p className="text-muted-foreground text-sm leading-relaxed mb-8 max-w-sm">
                      {isTelegramWorkflow ? (
                        <>
                          Votre bot <b>{workflowName}</b> est pr√™t. Entrez votre
                          token Telegram pour le mettre en ligne.
                        </>
                      ) : (
                        <>
                          Votre automatisation <b>{workflowName}</b> est pr√™te.
                          Pour la mettre en ligne, vous devez connecter votre
                          num√©ro WhatsApp.
                        </>
                      )}
                    </p>

                    {!isTelegramWorkflow ? (
                      <div className="space-y-6">
                        {!isPhoneSubmitted ? (
                          <div className="space-y-4">
                            <div>
                              <label className="text-[10px] font-black uppercase text-white/40 mb-2 block tracking-widest">
                                √âtape 0 : Votre num√©ro WhatsApp
                              </label>
                              <div className="phone-input-container">
                                <PhoneInput
                                  placeholder="Entrez votre num√©ro de t√©l√©phone"
                                  value={userPhoneNumber}
                                  onChange={(val) =>
                                    setUserPhoneNumber(val || "")
                                  }
                                  defaultCountry="CI"
                                  international
                                  countryCallingCodeEditable={false}
                                  labels={customLabels}
                                  className="premium-phone-input"
                                />
                              </div>
                            </div>
                            <div className="p-4 bg-emerald-500/5 border border-emerald-500/10 rounded-2xl">
                              <p className="text-[10px] text-emerald-400 leading-relaxed italic">
                                C&apos;est le num√©ro qui sera utilis√© pour
                                envoyer les messages automatiques √† vos clients.
                              </p>
                            </div>
                            <Button
                              onClick={() => setIsPhoneSubmitted(true)}
                              disabled={!userPhoneNumber}
                              className="w-full bg-emerald-500 hover:bg-emerald-600 text-white font-bold h-12 rounded-xl"
                            >
                              Continuer vers la connexion
                            </Button>
                          </div>
                        ) : (
                          <>
                            <div className="flex items-start gap-4">
                              <div className="h-6 w-6 rounded-full bg-primary/20 text-primary flex items-center justify-center text-[10px] font-black shrink-0">
                                1
                              </div>
                              <div>
                                <p className="text-sm font-bold text-white">
                                  Pr√©parez votre t√©l√©phone
                                </p>
                                <p className="text-xs text-muted-foreground">
                                  Ouvrez WhatsApp &gt; R√©glages &gt; Appareils
                                  connect√©s
                                </p>
                              </div>
                            </div>
                            <div className="flex items-start gap-4">
                              <div className="h-6 w-6 rounded-full bg-white/5 text-white/40 flex items-center justify-center text-[10px] font-black shrink-0">
                                2
                              </div>
                              <div>
                                <p className="text-sm font-bold text-white/60">
                                  Scannez le code QR
                                </p>
                                <p className="text-xs text-muted-foreground/50">
                                  Utilisez votre mobile pour scanner le code √†
                                  droite
                                </p>
                              </div>
                            </div>
                            <div className="flex items-start gap-4 text-emerald-400 opacity-80 italic">
                              <div className="h-6 w-6 rounded-full bg-emerald-500/20 flex items-center justify-center text-[10px] font-black shrink-0 font-sans">
                                ‚úì
                              </div>
                              <div className="flex-1">
                                <p className="text-xs">
                                  Num√©ro enregistr√© : {userPhoneNumber}
                                </p>
                                <button
                                  onClick={() => setIsPhoneSubmitted(false)}
                                  className="text-[10px] underline hover:text-emerald-300 transition-colors mt-1"
                                >
                                  Modifier le num√©ro
                                </button>
                              </div>
                            </div>
                          </>
                        )}
                      </div>
                    ) : (
                      <div className="space-y-6">
                        <div className="space-y-4">
                          <div>
                            <label className="text-[10px] font-black uppercase text-white/40 mb-2 block">
                              Token du Bot (via @BotFather)
                            </label>
                            <Input
                              value={tgBotToken}
                              onChange={(e) => setTgBotToken(e.target.value)}
                              placeholder="Ex: 123456789:ABCDefGhIjkLmNoPqRsTuVwXyZ"
                              className="bg-white/5 border-white/10 text-white font-mono text-sm h-12 rounded-xl focus:ring-[#24a1de]/20"
                            />
                          </div>
                          <div className="p-4 bg-blue-500/5 border border-blue-500/10 rounded-2xl">
                            <p className="text-[10px] text-blue-400 leading-relaxed italic">
                              Note : Allez sur Telegram, cherchez{" "}
                              <b>@BotFather</b>, cr√©ez un nouveau bot et copiez
                              son "API Token" ici pour activer l'automatisation.
                            </p>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>

                  {/* Message d'erreur */}
                  {launchError && (
                    <div className="p-3 bg-red-500/10 border border-red-500/20 rounded-xl mb-4">
                      <p className="text-[11px] text-red-400 font-medium">
                        ‚ùå {launchError}
                      </p>
                    </div>
                  )}

                  {/* Message de succ√®s */}
                  {launchSuccess && (
                    <div className="p-3 bg-emerald-500/10 border border-emerald-500/20 rounded-xl mb-4">
                      <p className="text-[11px] text-emerald-400 font-medium">
                        ‚úÖ Automatisation lanc√©e avec succ√®s ! Elle est
                        maintenant active 24/7.
                      </p>
                    </div>
                  )}

                  <div className="flex gap-4">
                    <Button
                      variant="ghost"
                      onClick={() => {
                        setShowPublishModal(false);
                        setLaunchError(null);
                        setLaunchSuccess(false);
                      }}
                      className="px-8 bg-white/5 hover:bg-white/10"
                    >
                      {launchSuccess ? "Fermer" : "Annuler"}
                    </Button>
                    {isTelegramWorkflow ? (
                      <Button
                        disabled={!tgBotToken}
                        className="px-8 bg-[#24a1de] hover:bg-[#2090c7] text-white font-bold gap-2 rounded-xl shadow-[0_0_20px_rgba(36,161,222,0.3)] transition-all hover:scale-105 active:scale-95"
                      >
                        <Rocket className="h-4 w-4" /> Lancer le Bot Telegram
                      </Button>
                    ) : (
                      isClientWhatsAppConnected && (
                        <Button
                          onClick={handleLaunchAutomation}
                          disabled={isLaunching || launchSuccess}
                          className="px-8 bg-emerald-500 hover:bg-emerald-600 text-white font-bold gap-2 disabled:opacity-50"
                        >
                          {isLaunching ? (
                            <>
                              <Loader2 className="h-4 w-4 animate-spin" />{" "}
                              Lancement...
                            </>
                          ) : launchSuccess ? (
                            <>
                              <Check className="h-4 w-4" /> Lanc√© avec succ√®s !
                            </>
                          ) : (
                            <>
                              <Rocket className="h-4 w-4" /> Lancer
                              l&apos;automatisation
                            </>
                          )}
                        </Button>
                      )
                    )}
                  </div>
                </div>

                {/* Right Side: QR Code & Live Preview */}
                <div className="w-[400px] bg-black/40 p-12 flex flex-col items-center justify-center relative">
                  <div className="absolute top-8 right-8">
                    <Badge
                      className={`${isTelegramWorkflow ? "bg-blue-500/10 text-blue-400 border-blue-500/20" : "bg-emerald-500/10 text-emerald-400 border-emerald-500/20"} px-3 py-1`}
                    >
                      Production
                    </Badge>
                  </div>

                  <WhatsAppSimulator
                    isProduction={true}
                    userId={automationWhatsAppId || "guest"}
                    onConnect={() => setIsClientWhatsAppConnected(true)}
                    nodes={nodes}
                  />
                </div>
              </motion.div>
            </div>
          )}
        </AnimatePresence>

        {/* Connection Modal */}
        <AnimatePresence>
          {showConnectionModal && (
            <div className="fixed inset-0 z-[5500] flex items-center justify-center p-4">
              <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                onClick={() => setShowConnectionModal(false)}
                className="absolute inset-0 bg-black/80 backdrop-blur-md"
              />
              <motion.div
                initial={{ opacity: 0, scale: 0.9, y: 20 }}
                animate={{ opacity: 1, scale: 1, y: 0 }}
                exit={{ opacity: 0, scale: 0.9, y: 20 }}
                className="relative w-full max-w-4xl bg-[#171717] border border-white/10 rounded-[40px] shadow-2xl overflow-hidden flex"
                style={{ height: "600px" }}
              >
                <div className="flex-1 p-12 flex flex-col border-r border-white/5 overflow-y-auto">
                  <div className="flex-1">
                    <div className="h-14 w-14 rounded-2xl bg-emerald-500/10 flex items-center justify-center mb-8">
                      <WhatsAppIcon className="h-7 w-7" />
                    </div>
                    <h2 className="text-3xl font-black text-white mb-4 italic uppercase">
                      Lier votre WhatsApp
                    </h2>
                    <div className="mb-4 p-3 bg-primary/5 border border-primary/10 rounded-xl">
                      <p className="text-[9px] font-black uppercase tracking-widest text-primary/60 mb-1">
                        Automatisation
                      </p>
                      <p className="text-sm font-bold text-white">
                        {workflowName}
                      </p>
                      <p className="text-[8px] text-muted-foreground/50 font-mono mt-1">
                        ID: {automationId}
                      </p>
                    </div>
                    <p className="text-muted-foreground text-sm leading-relaxed mb-8 max-w-sm">
                      {!isPhoneSubmitted
                        ? "Entrez votre num√©ro de t√©l√©phone WhatsApp pour cette automatisation. Chaque workflow peut avoir son propre num√©ro WhatsApp."
                        : "Scannez le code QR avec votre t√©l√©phone pour activer les automatisations sur ce workflow."}
                    </p>

                    {!isPhoneSubmitted ? (
                      <div className="space-y-6">
                        <div className="space-y-4">
                          <div>
                            <label className="text-[10px] font-black uppercase text-white/40 mb-2 block tracking-widest">
                              Votre num√©ro WhatsApp
                            </label>
                            <div className="phone-input-container">
                              <PhoneInput
                                placeholder="Entrez votre num√©ro de t√©l√©phone"
                                value={userPhoneNumber}
                                onChange={(val) =>
                                  setUserPhoneNumber(val || "")
                                }
                                defaultCountry="CI"
                                international
                                countryCallingCodeEditable={false}
                                labels={customLabels}
                                className="premium-phone-input"
                              />
                            </div>
                          </div>
                          <div className="p-4 bg-emerald-500/5 border border-emerald-500/10 rounded-2xl">
                            <p className="text-[10px] text-emerald-400 leading-relaxed italic">
                              C&apos;est le num√©ro qui sera utilis√© pour
                              recevoir et envoyer les messages automatiques √†
                              vos clients.
                            </p>
                          </div>
                          <div className="p-3 bg-amber-500/5 border border-amber-500/10 rounded-2xl">
                            <p className="text-[9px] text-amber-400/80 leading-relaxed">
                              üí° <strong>Important :</strong> Si vous avez d√©j√†
                              connect√© ce num√©ro √† une autre automatisation,
                              vous devrez utiliser un num√©ro diff√©rent pour ce
                              workflow.
                            </p>
                          </div>
                        </div>
                      </div>
                    ) : (
                      <div className="space-y-6">
                        <div className="flex items-start gap-4">
                          <div className="h-6 w-6 rounded-full bg-emerald-500/20 text-emerald-400 flex items-center justify-center text-[10px] font-black shrink-0">
                            ‚úì
                          </div>
                          <div>
                            <p className="text-sm font-bold text-emerald-400">
                              Num√©ro enregistr√©
                            </p>
                            <p className="text-xs text-muted-foreground">
                              {userPhoneNumber}
                              <button
                                onClick={() => setIsPhoneSubmitted(false)}
                                className="ml-2 text-emerald-400 underline hover:text-emerald-300 transition-colors"
                              >
                                Modifier
                              </button>
                            </p>
                          </div>
                        </div>
                        <div className="flex items-start gap-4">
                          <div className="h-6 w-6 rounded-full bg-emerald-500/20 text-emerald-400 flex items-center justify-center text-[10px] font-black shrink-0">
                            1
                          </div>
                          <div>
                            <p className="text-sm font-bold text-white">
                              Pr√©parez votre t√©l√©phone
                            </p>
                            <p className="text-xs text-muted-foreground">
                              Ouvrez WhatsApp &gt; R√©glages &gt; Appareils
                              connect√©s
                            </p>
                          </div>
                        </div>
                        <div className="flex items-start gap-4">
                          <div className="h-6 w-6 rounded-full bg-white/5 text-white/40 flex items-center justify-center text-[10px] font-black shrink-0">
                            2
                          </div>
                          <div>
                            <p className="text-sm font-bold text-white/60">
                              Scannez le code QR
                            </p>
                            <p className="text-xs text-muted-foreground/50">
                              Utilisez votre mobile pour scanner le code √†
                              droite
                            </p>
                          </div>
                        </div>
                      </div>
                    )}
                  </div>
                  <div className="flex gap-4 mt-8 pt-4">
                    <Button
                      variant="ghost"
                      onClick={() => setShowConnectionModal(false)}
                      className="px-8 bg-white/5 hover:bg-white/10"
                    >
                      Fermer
                    </Button>
                    {!isPhoneSubmitted && (
                      <Button
                        onClick={() => setIsPhoneSubmitted(true)}
                        disabled={!userPhoneNumber}
                        className="flex-1 bg-emerald-500 hover:bg-emerald-600 text-white font-bold h-12 rounded-xl"
                      >
                        Continuer
                      </Button>
                    )}
                  </div>
                </div>
                <div className="w-[400px] bg-black/40 p-12 flex flex-col items-center justify-center relative">
                  {!isPhoneSubmitted ? (
                    <div className="text-center space-y-6">
                      <div className="h-32 w-32 rounded-3xl bg-white/5 border-2 border-dashed border-white/10 flex items-center justify-center mx-auto">
                        <QrCode className="h-12 w-12 text-white/20" />
                      </div>
                      <div className="space-y-2">
                        <p className="text-sm font-bold text-white/40">
                          Code QR en attente
                        </p>
                        <p className="text-xs text-muted-foreground/50 max-w-[200px] mx-auto">
                          Entrez votre num√©ro de t√©l√©phone pour g√©n√©rer le code
                          QR
                        </p>
                      </div>
                    </div>
                  ) : (
                    <WhatsAppSimulator
                      isProduction={true}
                      userId={automationWhatsAppId || "guest"}
                      onConnect={() => {
                        setIsClientWhatsAppConnected(true);
                        setTimeout(() => setShowConnectionModal(false), 2000);
                      }}
                      nodes={[]}
                    />
                  )}
                </div>
              </motion.div>
            </div>
          )}
        </AnimatePresence>

        {/* Product Management Modal */}
        <AnimatePresence>
          {isProductModalOpen && (
            <div className="fixed inset-0 z-[6000] flex items-center justify-center p-4">
              <motion.div
                initial={{ opacity: 0 }}
                animate={{ opacity: 1 }}
                exit={{ opacity: 0 }}
                onClick={() => {
                  setIsProductModalOpen(false);
                  setEditingProduct(null);
                }}
                className="absolute inset-0 bg-black/60 backdrop-blur-sm"
              />
              <motion.div
                initial={{ opacity: 0, scale: 0.95, y: 20 }}
                animate={{ opacity: 1, scale: 1, y: 0 }}
                exit={{ opacity: 0, scale: 0.95, y: 20 }}
                className="relative w-full max-w-lg bg-[#1a1a1a] border border-white/10 rounded-[32px] shadow-2xl overflow-hidden p-8"
              >
                <div className="flex items-center justify-between mb-8">
                  <h2 className="text-xl font-black text-white italic uppercase tracking-tight">
                    {editingProduct ? "Modifier le Produit" : "Nouveau Produit"}
                  </h2>
                  <Button
                    variant="ghost"
                    size="icon"
                    onClick={() => {
                      setIsProductModalOpen(false);
                      setEditingProduct(null);
                    }}
                    className="rounded-full hover:bg-white/5"
                  >
                    <X className="h-4 w-4" />
                  </Button>
                </div>

                <div className="space-y-4">
                  <div className="flex gap-4">
                    <div className="relative group h-24 w-24 rounded-2xl bg-white/5 border border-white/10 flex items-center justify-center shrink-0 overflow-hidden">
                      {(editingProduct
                        ? editingProduct.image
                        : newProduct.image
                      ).startsWith("http") ||
                        (editingProduct
                          ? editingProduct.image
                          : newProduct.image
                        ).startsWith("data:image") ? (
                        <img
                          src={
                            editingProduct
                              ? editingProduct.image
                              : newProduct.image
                          }
                          alt="Preview"
                          className="w-full h-full object-cover"
                        />
                      ) : (
                        <span className="text-4xl">
                          {editingProduct
                            ? editingProduct.image
                            : newProduct.image}
                        </span>
                      )}

                      <button
                        onClick={() => fileInputRef.current?.click()}
                        className="absolute inset-0 bg-black/60 opacity-0 group-hover:opacity-100 transition-opacity flex flex-col items-center justify-center gap-1"
                      >
                        <Upload className="h-5 w-5 text-white" />
                        <span className="text-[8px] font-bold text-white uppercase">
                          Upload
                        </span>
                      </button>

                      <input
                        type="file"
                        ref={fileInputRef}
                        className="hidden"
                        accept="image/*"
                        onChange={handleImageUpload}
                      />
                    </div>
                    <div className="flex-1 space-y-4">
                      <div>
                        <label className="text-[10px] font-black uppercase text-white/40 mb-2 block">
                          Nom du Produit
                        </label>
                        <Input
                          value={
                            editingProduct
                              ? editingProduct.name
                              : newProduct.name
                          }
                          onChange={(e) =>
                            editingProduct
                              ? setEditingProduct({
                                ...editingProduct,
                                name: e.target.value,
                              })
                              : setNewProduct({
                                ...newProduct,
                                name: e.target.value,
                              })
                          }
                          className="bg-white/5 border-white/10 h-10"
                          placeholder="Ex: iPhone 15 Pro"
                        />
                      </div>
                      <div className="flex gap-2 items-end">
                        <div className="flex-1">
                          <label className="text-[10px] font-black uppercase text-white/40 mb-2 block tracking-widest">
                            Image (URL ou Emoji)
                          </label>
                          <Input
                            value={
                              editingProduct
                                ? editingProduct.image
                                : newProduct.image
                            }
                            onChange={(e) =>
                              editingProduct
                                ? setEditingProduct({
                                  ...editingProduct,
                                  image: e.target.value,
                                })
                                : setNewProduct({
                                  ...newProduct,
                                  image: e.target.value,
                                })
                            }
                            className="bg-white/5 border-white/10 h-10 text-xs"
                            placeholder="URL ou Emoji"
                          />
                        </div>
                        <Button
                          variant="outline"
                          size="icon"
                          className="h-10 w-10 shrink-0 border-white/10 bg-white/5 hover:bg-white/10"
                          onClick={() => fileInputRef.current?.click()}
                        >
                          <ImageIcon className="h-4 w-4" />
                        </Button>
                      </div>
                    </div>
                  </div>

                  <div>
                    <label className="text-[10px] font-black uppercase text-white/40 mb-2 block tracking-widest">
                      Description
                    </label>
                    <textarea
                      value={
                        editingProduct
                          ? editingProduct.description
                          : newProduct.description
                      }
                      onChange={(e) =>
                        editingProduct
                          ? setEditingProduct({
                            ...editingProduct,
                            description: e.target.value,
                          })
                          : setNewProduct({
                            ...newProduct,
                            description: e.target.value,
                          })
                      }
                      className="w-full bg-white/5 border border-white/10 rounded-xl p-3 text-sm text-white focus:ring-1 focus:ring-primary outline-none transition-all min-h-[80px]"
                      placeholder="D√©crivez votre produit..."
                    />
                  </div>

                  <div className="grid grid-cols-2 gap-4">
                    <div>
                      <label className="text-[10px] font-black uppercase text-white/40 mb-2 block tracking-widest">
                        Prix ({currencySymbols[currency]})
                      </label>
                      <Input
                        type="number"
                        value={
                          editingProduct
                            ? editingProduct.price
                            : newProduct.price
                        }
                        onChange={(e) =>
                          editingProduct
                            ? setEditingProduct({
                              ...editingProduct,
                              price: e.target.value,
                            })
                            : setNewProduct({
                              ...newProduct,
                              price: e.target.value,
                            })
                        }
                        className="bg-white/5 border-white/10 h-10"
                        placeholder="999"
                      />
                    </div>
                    <div>
                      <label className="text-[10px] font-black uppercase text-white/40 mb-2 block tracking-widest">
                        Stock
                      </label>
                      <Input
                        type="number"
                        value={
                          editingProduct
                            ? editingProduct.stock
                            : newProduct.stock
                        }
                        onChange={(e) =>
                          editingProduct
                            ? setEditingProduct({
                              ...editingProduct,
                              stock: e.target.value,
                            })
                            : setNewProduct({
                              ...newProduct,
                              stock: e.target.value,
                            })
                        }
                        className="bg-white/5 border-white/10 h-10"
                        placeholder="50"
                      />
                    </div>
                  </div>

                  <div>
                    <label className="text-[10px] font-black uppercase text-white/40 mb-2 block tracking-widest">
                      √âtiquettes (s√©par√©es par des virgules)
                    </label>
                    <Input
                      value={
                        editingProduct
                          ? editingProduct.labels
                          : newProduct.labels
                      }
                      onChange={(e) =>
                        editingProduct
                          ? setEditingProduct({
                            ...editingProduct,
                            labels: e.target.value,
                          })
                          : setNewProduct({
                            ...newProduct,
                            labels: e.target.value,
                          })
                      }
                      className="bg-white/5 border-white/10 h-10"
                      placeholder="Apple, Mobile, Premium"
                    />
                  </div>
                </div>

                <div className="mt-10 flex gap-4">
                  <Button
                    variant="ghost"
                    onClick={() => {
                      setIsProductModalOpen(false);
                      setEditingProduct(null);
                    }}
                    className="flex-1 bg-white/5 hover:bg-white/10 h-12 rounded-xl"
                  >
                    Annuler
                  </Button>
                  <Button
                    onClick={
                      editingProduct ? handleUpdateProduct : handleAddProduct
                    }
                    className="flex-1 bg-primary text-black font-black h-12 rounded-xl shadow-[0_0_20px_rgba(135,169,255,0.3)] transition-all hover:scale-[1.02] active:scale-[0.98]"
                  >
                    {editingProduct ? "Mettre √† jour" : "Ajouter le Produit"}
                  </Button>
                </div>
              </motion.div>
            </div>
          )}
        </AnimatePresence>
      </main>
    </div>
  );
}
